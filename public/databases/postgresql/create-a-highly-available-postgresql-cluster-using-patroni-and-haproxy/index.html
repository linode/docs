<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Create a Highly Available PostgreSQL Cluster Using Patroni and HAProxy</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="description" content="This guide shows you how to set up a highly available PostgreSQL cluster using Patroni and HA Proxy on your Linode.">
        <meta name="keywords" content="postgresql, clusters, databases">
        
        <meta property="og:title" content="Create a Highly Available PostgreSQL Cluster Using Patroni and HAProxy">
        <meta property="og:type" content="article">
        <meta property="og:url" content="https://linode.com/docs/databases/postgresql/create-a-highly-available-postgresql-cluster-using-patroni-and-haproxy/">
        <meta property="og:description" content="This guide shows you how to set up a highly available PostgreSQL cluster using Patroni and HA Proxy on your Linode.">
        <meta property="og:site_name" content="Linode Guides &amp; Tutorials">
        
        
        <meta name="twitter:card" content="summary">
        
        <meta name="twitter:site" content="@linode">
        <link rel="alternate" type="application/rss" href="https://linode.com/docs/index.xml">

        
             <link href="/docs/build/stylesheets/home.css" rel='stylesheet' type='text/css'>

        
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,900' rel='stylesheet' type='text/css'>
        <link rel="canonical" href="https://linode.com/docs/databases/postgresql/create-a-highly-available-postgresql-cluster-using-patroni-and-haproxy/">
        <link rel="shortcut icon" href="/favicon.ico">
    </head>
    <body class="no-subnav">
         <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="searchLabel" id="ds-search-modal">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div id="ds-search-input">
				<div class="input-group col-md-12">
					<input id="ds-search" type="text" class="form-control input-lg" placeholder="Search" />
					<span class="input-group-btn">
						<button class="btn btn-info btn-lg" id="ds-search-btn-modal" type="button">
						<i class="glyphicon glyphicon-search"></i>
						</button>
					</span>
				</div>
				<ul class="list-group" id="ds-search-list">
				</ul>
			</div>
		</div>
	</div>
</div> 
         
        <header>
            <nav id="main-nav" class="navbar navbar-default" role="navigation">
  <div class="container">

    <div class="navbar-header">
      <button type="button" class="toggle navbar-toggle" data-toggle="collapse" data-target=".navbar-top-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://www.linode.com"><img id="navbar-logo" src="/docs/media/images/header/linode-logo.svg" style="height:57px"></a>
    </div>

    <div class="collapse navbar-collapse navbar-top-collapse">
      <ul class="nav navbar-nav navbar-right">

                <li><a href="https://www.linode.com/"><span class='nav-home'></span></a></li>
                <li><a href="https://www.linode.com/linodes">Features</a></li>
                <li><a href="https://www.linode.com/pricing">Pricing</a></li>
                <li><a href="https://www.linode.com/addons">Add-ons</a></li>

        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Resources <span class="caret"></span></a>
          <ul class="dropdown-menu dropdown-main-nav dropdown-mega">
            <li class="dropdown-third">
              <ul >
                <li><a href="https://linode.com/docs/getting-started">Getting Started</a></li>
                <li><a href="https://linode.com/docs/migrate-from-shared">Migrating to Linode</a></li>
                <li><a href="https://linode.com/docs/hosting-website">Hosting a Website</a></li>
                <li class="divider"></li>
                <li class="big"><a href="https://linode.com/docs"><i class="fa fa-book"></i> Guides &amp; Tutorials</a></li>
                <li class="divider visible-xs"></li>
              </ul>
            </li>
            <li class="dropdown-third middle">
              <ul >
                <li><a href="https://www.linode.com/api">API</a></li>
                <li><a href="https://www.linode.com/stackscripts">StackScripts</a></li>
                <li><a href="https://www.linode.com/mobile">Mobile</a></li>
                <li><a href="https://www.linode.com/cli" target="_blank">CLI</a></li>

                <li class="divider"></li>

                <li><a href="https://www.linode.com/chat"><i class="fa fa-bullhorn gray"></i> Chat</a></li>
                <li><a href="https://forum.linode.com"><i class="fa fa-comments"></i> Community Forum</a></li>
                <li class="divider visible-xs"></li>
              </ul>
            </li>
            <li class="dropdown-third">
              <ul >
                <li><a href="https://blog.linode.com">Blog</a></li>
                <li><a href="http://status.linode.com">System Status</a></li>
                <li><a href="https://www.linode.com/speedtest">Speed Test</a></li>
                <li><a href="https://www.linode.com/about">About Us</a></li>
                <li class="divider"></li>
                <li><a href="https://www.linode.com/contact"><i class="fa fa-user"></i> Contact Support</a></li>
              </ul>
            </li>
          </ul>
        </li>

        <li role="presentation" class="divider-vertical"><span>|</span></li>
          <li class=""><a href="https://manager.linode.com/">Log in <span class="login-caret"></span></a></li>
          <li class="visible-xs"><a href="https://manager.linode.com/session/signup">Sign up</a></li>
          <li class="hidden-xs"><div><a id="btn-signup-top" class="btn btn-sm btn-green navbar-btn hidden-xs" href="https://manager.linode.com/session/signup">Sign up</a></div></li>
      </ul>
    </div>

  </div>
</nav>

            <nav class="navbar subnav jumbotron" role="navigation">
  <div class="container">
    <div class="subnav-divider">

    </div>
  </div>
</nav>
        </header>
        
<section class="primary first-section">
  <div class="container">
    <div class="row breadcrumb-row">
  <div class="col-sm-12">
    <ol class="breadcrumb library-breadcrumb">
      







<li>
  
  <a href="https://linode.com/docs/">Guides &amp; Tutorials</a>
  
</li>


<li>
  
  <a href="https://linode.com/docs/databases/">Database Management Systems</a>
  
</li>


<li>
  
  <a href="https://linode.com/docs/databases/postgresql/">PostgreSQL</a>
  
</li>


<li>
  
  Create a Highly Available PostgreSQL Cluster Using Patroni and HAProxy
  
</li>

    </ol>
  </div>
</div>

    <div class="row" itemscope itemtype="http://schema.org/TechArticle">
      <div class="col-sm-12">
        <div class="row">
          <div class="col-sm-9 col-sm-offset-3">
          </div>
        </div>
        <div class="row">
          <div id="article-body" class="col-sm-9 col-sm-push-3 doc">
            <h1 class="doc-title" itemprop="headline">Create a Highly Available PostgreSQL Cluster Using Patroni and HAProxy</h1>
<p markdown="0" class="doc-time doc-modified-time">
  <small class="updated">Updated <time itemprop="dateModified" datetime="2017-09-19T00:00:00Z">Tuesday, September 19, 2017</time> by Kulshekhar Kabra</small>
  
</p>

           <div class="row">
            <div class="col-sm-9"><div markdown="0" class="signup-top">
    <span>
        Use promo code <strong>DOCS10</strong> for $10 credit on a new account.
    </span>
    <form action="https://manager.linode.com/session/signup" style="display: inline">
        <button type="submit" target="_blank" class="btn btn-blue btn-sm btn-border">Try this Guide</button>
    </form>
</div>
</div>
            <div class="col-sm-3"><div class="social-share">
    <div class="btn-group share-group">
        <a data-toggle="dropdown" class="btn btn-info">
            <i class="fa fa-share-alt fa-inverse"></i>
        </a>
        <button href="#" data-toggle="dropdown" class="btn btn-info dropdown-toggle share">
        <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
            <li>
                <a data-original-title="Twitter" rel="tooltip"  href="https://twitter.com/share?url=https%3a%2f%2flinode.com%2fdocs%2fdatabases%2fpostgresql%2fcreate-a-highly-available-postgresql-cluster-using-patroni-and-haproxy%2f&via=linode&text=Create%20a%20Highly%20Available%20%e2%80%a6" class="btn btn-twitter" data-placement="left" target="_blank" rel="noopener">
                    <i class="fa fa-twitter"></i>
                </a>
            </li>
            <li>
                <a data-original-title="Facebook" rel="tooltip"  href="http://www.facebook.com/sharer.php?u=https%3a%2f%2flinode.com%2fdocs%2fdatabases%2fpostgresql%2fcreate-a-highly-available-postgresql-cluster-using-patroni-and-haproxy%2f" class="btn btn-facebook" data-placement="left" target="_blank" rel="noopener">
                    <i class="fa fa-facebook"></i>
                </a>
            </li>
            <li>
                <a data-original-title="Hacker News" rel="tooltip"  href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2flinode.com%2fdocs%2fdatabases%2fpostgresql%2fcreate-a-highly-available-postgresql-cluster-using-patroni-and-haproxy%2f&t=Create%20a%20Highly%20Available%20PostgreSQL%20Cluster%20Using%20Patroni%20and%20HAProxy" class="btn btn-hacker-news" data-placement="left" target="_blank" rel="noopener">
                    <i class="fa fa-hacker-news "></i>
                </a>
            </li>
        </ul>
    </div>
</div></div>
            </div>
            <div class="library-github" markdown="0">
	<i class="fa fa-github"></i>
	<strong>Contribute on GitHub</strong>
	<p>
		
		<a href="https://github.com/linode/docs">View Project</a> |
		<a href="https://github.com/linode/docs/blob/master/docs/databases/postgresql/create-a-highly-available-postgresql-cluster-using-patroni-and-haproxy.md">View File</a> |
		<a href="https://github.com/linode/docs/edit/master/docs/databases/postgresql/create-a-highly-available-postgresql-cluster-using-patroni-and-haproxy.md">Edit File</a>
	</p>
</div>
            
            

            

<p><img src="/docs/assets/postgresql-cluster-patroni.jpg" alt="Create a Highly Available PostgreSQL Cluster Using Patroni and HAProxy" title="Create a Highly Available PostgreSQL Cluster Using Patroni and HAProxy" /></p>

<h2 id="what-is-postgresql">What is PostgreSQL?</h2>

<p><a href="https://www.postgresql.org">PostgreSQL</a> (Postgres) is an open-source, fully <a href="https://en.wikipedia.org/wiki/ACID">ACID compliant</a> relational database that runs on all major operating systems. While Postgres is a highly versatile, feature-rich, and powerful database, it doesn&rsquo;t have a built-in solution for high availability.</p>

<p>This guide shows you how to create a highly available Postgres cluster of three servers using <a href="https://github.com/zalando/patroni">Patroni</a>.</p>

<h2 id="before-you-begin">Before You Begin</h2>

<ol>
<li><p>Familiarize yourself with our <a href="/docs/getting-started">Getting Started</a> guide and familiarize yourself with SSH and connecting to your linode.</p></li>

<li><p>This guide will use <code>sudo</code> wherever possible. Complete the sections of our <a href="/docs/security/securing-your-server">Securing Your Server</a> to create a standard user account and harden SSH access.</p></li>

<li><p>Update your system:</p>

<pre><code>sudo apt update &amp;&amp; sudo apt upgrade
</code></pre></li>

<li><p>Create five Linodes on your account, all within the same datacenter. Take note of each Linode&rsquo;s <a href="/docs/networking/remote-access/#adding-private-ip-addresses">private IP address</a></p></li>
</ol>

<blockquote class="note">
  <strong class="callout-title">Note</strong>
  <div>This guide is written for a non-root user. Commands that require elevated privileges are prefixed with <code>sudo</code>. If you’re not familiar with the <code>sudo</code> command, see the <a href="/docs/tools-reference/linux-users-and-groups">Users and Groups</a> guide.</div>
</blockquote>


<h2 id="install-postgresql">Install PostgreSQL</h2>

<p>Install Postgres on three Linodes in your setup. Because the configuration in this guide uses private IP addresses to communicate between Linodes in the same datacenter, this setup may not meet certain <a href="https://docs.oracle.com/cd/B28359_01/server.111/b28281/hadesign.htm#g1007388">Highly Available requirements</a>. For more information about private IPs, visit our <a href="/docs/networking/remote-access/#adding-private-ip-addresses">Remote Access guide</a>.</p>

<p>The examples in this guide assign the private IP addresses of the three Postgres Linodes <code>192.0.2.11</code>, <code>192.0.2.12</code> and <code>192.0.2.13</code>. To setup a private IP address on a Linode, refer to the <a href="/docs/networking/remote-access/#adding-private-ip-addresses">Remote Access guide</a> for more information.</p>

<ol>
<li><p>On the three Linodes where you want to install Postgres, update the package lists:</p>

<pre><code>sudo apt update
</code></pre></li>

<li><p>Install Postgres:</p>

<pre><code>sudo apt install postgresql-9.5 -y
</code></pre></li>

<li><p>Upon installation, Postgres automatically runs as a service. Stop the Postgres service so that Patroni can manage it from this point on:</p>

<pre><code>sudo systemctl stop postgresql
</code></pre></li>

<li><p>Patroni uses utilities that come installed with Postgres, located in the <code>/usr/lib/postgresql/9.5/bin</code> directory by default on Ubuntu 16.04. Create symbolic links in the <code>PATH</code> to ensure that Patroni can find the utilities:</p>

<pre><code>sudo ln -s /usr/lib/postgresql/9.5/bin/* /usr/sbin/
</code></pre>

<p>Instead of creating symlinks, you can include the <code>/usr/lib/postgresql/9.5/bin</code> directory in your <code>PATH</code>.</p></li>

<li><p>Repeat these steps on each of the three Linodes.</p></li>
</ol>

<h2 id="install-patroni">Install Patroni</h2>

<p>Patroni is an open-source Python package that manages Postgres configuration. It can be configured to handle tasks like replication, backups and restorations.</p>

<p>In this guide, you will use Patroni to:</p>

<ul>
<li>Configure the Postgres instance running on the same server</li>
<li>Configure replication from master to slaves</li>
<li>Automatically failover to the best slave in case the master goes down.</li>
</ul>

<ol>
<li><p>Install <code>python</code> and <code>pip</code>:</p>

<pre><code>sudo apt install python python-pip -y
</code></pre></li>

<li><p>Ensure that you have latest version of the <code>setuptools</code> python package:</p>

<pre><code>sudo pip install --upgrade setuptools
</code></pre></li>

<li><p>Use <code>pip</code> to install Patroni:</p>

<pre><code>sudo pip install patroni
</code></pre></li>

<li><p>Repeat these steps on each of the three Linodes.</p></li>
</ol>

<h2 id="install-etcd">Install etcd</h2>

<p>Etcd is a fault-tolerant, distributed key-value store that is used to store the state of the Postgres cluster. Via Patroni, all of the Postgres nodes make use of etcd to keep the Postgres cluster up and running.</p>

<p>In this guide you use a single-server etcd cluster. However, in production, it may be best to use a larger etcd cluster so that one etcd node fails, it doesn&rsquo;t affect your Postgres servers.</p>

<ol>
<li><p>On the Linode where you want etcd installed, update the package lists:</p>

<pre><code>sudo apt update
</code></pre></li>

<li><p>Install etcd:</p>

<pre><code>sudo apt install etcd -y
</code></pre></li>
</ol>

<p>The remainder of this guide uses <code>192.0.2.21</code> as the private IP address of this Linode.</p>

<h2 id="install-haproxy">Install HAProxy</h2>

<p>When developing an application that uses a database, it can be cumbersome to keep track of the database endpoints if they keep changing. Using HAProxy simplifies this by giving a single endpoint to which you can connect the application.</p>

<p>HAProxy forwards the connection to whichever node is currently the master. It does this using a REST endpoint that Patroni provides. Patroni ensures that, at any given time, only the master Postgres node will appear as online, forcing HAProxy to connect to the correct node.</p>

<ol>
<li><p>On the Linode where you want HAProxy installed, update the package lists:</p>

<pre><code>sudo apt update
</code></pre></li>

<li><p>Install HAProxy:</p>

<pre><code>sudo apt install haproxy -y
</code></pre></li>
</ol>

<p>This guide uses <code>192.0.2.31</code> as the private IP address of this server and <code>203.0.113.1</code> as its public IP address.</p>

<h2 id="current-status">Current Status</h2>

<p>At this stage, you should have a total of five Linodes:</p>

<table>
<thead>
<tr>
<th align="center">Example Private IP Address</th>
<th align="center">Software Installed</th>
<th align="center">Example Public IP Address</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">192.0.2.11</td>
<td align="center">Postgres, Patroni</td>
<td align="center">-</td>
</tr>

<tr>
<td align="center">192.0.2.12</td>
<td align="center">Postgres, Patroni</td>
<td align="center">-</td>
</tr>

<tr>
<td align="center">192.0.2.13</td>
<td align="center">Postgres, Patroni</td>
<td align="center">-</td>
</tr>

<tr>
<td align="center">192.0.2.21</td>
<td align="center">etcd</td>
<td align="center">-</td>
</tr>

<tr>
<td align="center">192.0.2.31</td>
<td align="center">HAProxy</td>
<td align="center">203.0.113.1</td>
</tr>
</tbody>
</table>

<h2 id="configure-etcd">Configure etcd</h2>

<ol>
<li><p>Edit the <code>/etc/default/etcd</code> file to add the following configuration:</p>

<dl class="file-excerpt">
<dt>


		/etc/default/etcd 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span><span class="lnt">12</span><span class="lnt">13</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">ETCD_LISTEN_PEER_URLS</span><span class="o">=</span><span class="s2">&#34;http://192.0.2.21:2380&#34;</span>

<span class="nv">ETCD_LISTEN_CLIENT_URLS</span><span class="o">=</span><span class="s2">&#34;http://localhost:2379,http://192.0.2.21:2379&#34;</span>

<span class="nv">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="o">=</span><span class="s2">&#34;http://192.0.2.21:2380&#34;</span>

<span class="nv">ETCD_INITIAL_CLUSTER</span><span class="o">=</span><span class="s2">&#34;etcd0=http://192.0.2.21:2380,&#34;</span>

<span class="nv">ETCD_ADVERTISE_CLIENT_URLS</span><span class="o">=</span><span class="s2">&#34;http://192.0.2.21:2379&#34;</span>

<span class="nv">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="o">=</span><span class="s2">&#34;cluster1&#34;</span>

<span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">&#34;new&#34;</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>
</li>

<li><p>Save the file, then restart the etcd service:</p>

<pre><code>sudo systemctl restart etcd
</code></pre></li>
</ol>

<h2 id="configure-patroni">Configure Patroni</h2>

<p>Patroni can be configured using a YAML file which can be placed anywhere. In this guide, you will place this file at <code>/etc/patroni.yml</code>.</p>

<p>Create a <code>patroni.yml</code> file on all three Linodes that have Postgres and Patroni installed (<code>192.0.2.11</code>, <code>192.0.2.12</code>, and <code>192.0.2.13</code> in this guide). Change <code>name</code> to something unique, and change <code>listen</code> and <code>connect_address</code> (under <code>postgresql</code> and <code>restapi</code>) to the appropriate values on each Linode.</p>

<ol>
<li><p>Edit this file to have the following content:</p>

<dl class="file">
<dt>


		/etc/patroni.yml 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span><span class="lnt">12</span><span class="lnt">13</span><span class="lnt">14</span><span class="lnt">15</span><span class="lnt">16</span><span class="lnt">17</span><span class="lnt">18</span><span class="lnt">19</span><span class="lnt">20</span><span class="lnt">21</span><span class="lnt">22</span><span class="lnt">23</span><span class="lnt">24</span><span class="lnt">25</span><span class="lnt">26</span><span class="lnt">27</span><span class="lnt">28</span><span class="lnt">29</span><span class="lnt">30</span><span class="lnt">31</span><span class="lnt">32</span><span class="lnt">33</span><span class="lnt">34</span><span class="lnt">35</span><span class="lnt">36</span><span class="lnt">37</span><span class="lnt">38</span><span class="lnt">39</span><span class="lnt">40</span><span class="lnt">41</span><span class="lnt">42</span><span class="lnt">43</span><span class="lnt">44</span><span class="lnt">45</span><span class="lnt">46</span><span class="lnt">47</span><span class="lnt">48</span><span class="lnt">49</span><span class="lnt">50</span><span class="lnt">51</span><span class="lnt">52</span><span class="lnt">53</span><span class="lnt">54</span><span class="lnt">55</span><span class="lnt">56</span><span class="lnt">57</span><span class="lnt">58</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">scope: postgres
namespace: /db/
name: postgresql0

restapi:
    listen: <span class="m">192</span>.0.2.11:8008
    connect_address: <span class="m">192</span>.0.2.11:8008

etcd:
    host: <span class="m">192</span>.0.2.21:2379

bootstrap:
    dcs:
        ttl: <span class="m">30</span>
        loop_wait: <span class="m">10</span>
        retry_timeout: <span class="m">10</span>
        maximum_lag_on_failover: <span class="m">1048576</span>
        postgresql:
            use_pg_rewind: <span class="nb">true</span>

    initdb:
    - encoding: UTF8
    - data-checksums

    pg_hba:
    - host replication replicator <span class="m">127</span>.0.0.1/32 md5
    - host replication replicator <span class="m">192</span>.0.2.11/0 md5
    - host replication replicator <span class="m">192</span>.0.2.12/0 md5
    - host replication replicator <span class="m">192</span>.0.2.13/0 md5
    - host all all <span class="m">0</span>.0.0.0/0 md5

    users:
        admin:
            password: admin
            options:
                - createrole
                - createdb

postgresql:
    listen: <span class="m">192</span>.0.2.11:5432
    connect_address: <span class="m">192</span>.0.2.11:5432
    data_dir: /data/patroni
    pgpass: /tmp/pgpass
    authentication:
        replication:
            username: replicator
            password: rep-pass
        superuser:
            username: postgres
            password: secretpassword
    parameters:
        unix_socket_directories: <span class="s1">&#39;.&#39;</span>

tags:
    nofailover: <span class="nb">false</span>
    noloadbalance: <span class="nb">false</span>
    clonefrom: <span class="nb">false</span>
    nosync: false</code></pre></td></tr></table>
</div>
</div>
</dd>
</dl></li>

<li><p>Make note of the <code>data_dir</code> value in the above file. The <code>postgres</code> user needs the ability to write to this directory. If this directory doesn&rsquo;t exist, create it:</p>

<pre><code>sudo mkdir /data/patroni -p
</code></pre></li>

<li><p>Make <code>postgres</code> the owner of <code>/data/patroni</code>:</p>

<pre><code>sudo chown postgres:postgres /data/patroni
</code></pre></li>

<li><p>Change the permissions on this directory to make it accessible only to the <code>postgres</code> user:</p>

<pre><code>sudo chmod 700 /data/patroni
</code></pre>

<p>Every option in the above file is configurable. View the <a href="https://github.com/zalando/patroni/blob/master/postgres0.yml">latest version of the postgres0.yml file</a> in Patroni&rsquo;s Github repository.</p></li>

<li><p>Create a <code>systemd</code> script that will allow you to start, stop and monitor Patroni. Create a file at <code>/etc/systemd/system/patroni.service</code> with the following content:</p>

<dl class="file">
<dt>


		/etc/systemd/system/patroni.service 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span><span class="lnt">12</span><span class="lnt">13</span><span class="lnt">14</span><span class="lnt">15</span><span class="lnt">16</span><span class="lnt">17</span><span class="lnt">18</span><span class="lnt">19</span><span class="lnt">20</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Runners to orchestrate a high-availability PostgreSQL
<span class="nv">After</span><span class="o">=</span>syslog.target network.target

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">Type</span><span class="o">=</span>simple

<span class="nv">User</span><span class="o">=</span>postgres
<span class="nv">Group</span><span class="o">=</span>postgres

<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/patroni /etc/patroni.yml

<span class="nv">KillMode</span><span class="o">=</span>process

<span class="nv">TimeoutSec</span><span class="o">=</span><span class="m">30</span>

<span class="nv">Restart</span><span class="o">=</span>no

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.targ</code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>

<p>If <code>patroni</code> is installed in a location other than <code>/usr/local/bin/patroni</code> on your machine, update the above file accordingly.</p></li>

<li><p>Start Patroni and Postgres:</p>

<pre><code>sudo systemctl start patroni
</code></pre></li>

<li><p>Check the status of Patroni:</p>

<pre><code>sudo systemctl status patroni
</code></pre>

<p>If everything is set up correctly, the output from the first node (leader) will resemble:</p>

<pre><code>● patroni.service - Runners to orchestrate a high-availability PostgreSQL
Loaded: loaded (/etc/systemd/system/patroni.service; enabled; vendor preset: enabled)
Active: active (running) since Thu 2017-07-29 16:49:18 UTC; 8min ago
Main PID: 13097 (patroni)

.
.
.

... INFO: Lock owner: postgresql0; I am postgresql0
... INFO: no action.  i am the leader with the lock
</code></pre>

<p>When starting subsequent nodes, the log will resemble:</p>

<pre><code>INFO: no action.  i am a secondary and i am following a leader
Lock owner: postgresql0; I am postgresql2
</code></pre></li>

<li><p>Repeat these steps on each of the three Linodes with Postgres installed to create a highly available Postgres cluster with one master and two slaves.</p></li>
</ol>

<h2 id="configure-haproxy">Configure HAProxy</h2>

<p>With the Postgres cluster set up, you need a way to connect to the master regardless of which of the servers in the cluster is the master. This is where HAProxy comes in. All Postgres clients (your applications, <code>psql</code>, etc.) will connect to HAProxy which will make sure you connect to the master in the cluster.</p>

<ol>
<li><p>On the Linode that has HAProxy installed, edit the configuration file at <code>/etc/haproxy/haproxy.cfg</code> to contain the following:</p>

<dl class="file">
<dt>


		/etc/haproxy/haproxy.cfg 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span><span class="lnt">12</span><span class="lnt">13</span><span class="lnt">14</span><span class="lnt">15</span><span class="lnt">16</span><span class="lnt">17</span><span class="lnt">18</span><span class="lnt">19</span><span class="lnt">20</span><span class="lnt">21</span><span class="lnt">22</span><span class="lnt">23</span><span class="lnt">24</span><span class="lnt">25</span><span class="lnt">26</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">global
    maxconn <span class="m">100</span>

defaults
    log global
    mode tcp
    retries <span class="m">2</span>
    timeout client 30m
    timeout connect 4s
    timeout server 30m
    timeout check 5s

listen stats
    mode http
    <span class="nb">bind</span> *:7000
    stats <span class="nb">enable</span>
    stats uri /

listen postgres
    <span class="nb">bind</span> *:5000
    option httpchk
    http-check expect status <span class="m">200</span>
    default-server inter 3s fall <span class="m">3</span> rise <span class="m">2</span> on-marked-down shutdown-sessions
    server postgresql_192.0.2.11_5432 <span class="m">192</span>.0.2.11:5432 maxconn <span class="m">100</span> check port <span class="m">8008</span>
    server postgresql_192.0.2.12_5432 <span class="m">192</span>.0.2.12:5432 maxconn <span class="m">100</span> check port <span class="m">8008</span>
    server postgresql_192.0.2.13_5432 <span class="m">192</span>.0.2.13:5432 maxconn <span class="m">100</span> check port <span class="m">8008</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>

<p>This configuration exposes HAProxy stats on a public URL. In a production setup, it might be better to restrict this to an internal network/localhost and access it via an SSH tunnel.</p></li>

<li><p>Restart HAProxy to use the new settings:</p>

<pre><code>sudo systemctl restart haproxy
</code></pre>

<p>If HAProxy fails to start, check for syntax errors:</p>

<pre><code>/usr/sbin/haproxy -c -V -f /etc/haproxy/haproxy.cfg
</code></pre></li>
</ol>

<h2 id="test-the-setup">Test the Setup</h2>

<ol>
<li><p>Connect Postgres clients to the public IP address of the Linode on which you installed HAProxy (in this guide, <code>203.0.113.1</code>) on port <code>5000</code>.</p></li>

<li><p>You can also connect to the HAProxy Linode on port <code>7000</code> to see the HAProxy dashboard:</p>

<p><img src="/docs/assets/pgha-haproxy-1-small.png" alt="HAProxy dashboard - all servers running" title="HAProxy dashboard - all servers running" /></p>

<p>In the <code>postgres</code> section, the <code>postgresql_192.0.2.11_5432</code> row is highlighted in green. This indicates that <code>192.0.2.11</code> is currently acting as the master.</p></li>

<li><p>If you kill the primary Linode (using <code>sudo systemctl stop patroni</code> or by shutting down the server), the dashboard will look similar to:</p>

<p><img src="/docs/assets/pgha-haproxy-2-small.png" alt="HAProxy dashboard - when primary fails" title="HAProxy dashboard - when primary fails" /></p>

<p>In the <code>postgres</code> section, the <code>postgresql_192.0.2.11_5432</code> row is now red and the <code>postgresql_192.0.2.13_5432</code> row is highlighted in green. This indicates that <code>192.0.2.13</code> is currently acting as the master.</p>

<blockquote class="note">
  <strong class="callout-title">Note</strong>
  <div>In this case, it just so happens that the third Postgres server is promoted to master. This might not always be the case. It is equally likely that the second server may be promoted to master.</div>
</blockquote>
</li>
</ol>

<p>When you now bring up the first server, it will rejoin the cluster as a slave and will sync up with the master.</p>

<p>You now have a robust, highly available Postgres cluster ready for use.</p>

<h2 id="possible-next-steps">Possible Next Steps</h2>

<p>While the setup in this guide should go far in making your Postgres deployment highly available, here are steps you can take to improve it further:</p>

<ol>
<li>Use a larger etcd cluster to improve availability.</li>
<li>Use PgBouncer to pool connections.</li>
<li>Add another HAProxy server and configure IP failover to create a highly available HAProxy cluster.</li>
</ol>

            
<h2>More Information</h2>
<p>You may wish to consult the following resources for additional information on this topic. While these are provided in the hope that they will be useful, please note that we cannot vouch for the accuracy or timeliness of externally hosted materials.</p>
<ul>

<li><a href="https://www.postgresql.org/docs/">PostgreSQL Documentation</a></li>

<li><a href="https://github.com/zalando/patroni">Patroni Repository</a></li>

<li><a href="https://coreos.com/etcd/docs/latest/">etcd Documentation</a></li>

</ul>


            

<h2>See Also</h2>
<ul>
    
    
    <li><a href="/docs/databases/mongodb/creating-a-mongodb-replication-set-on-debian-7-wheezy/">Creating a MongoDB Replication Set on Debian 7 (Wheezy) - Deprecated</a></li>
    
    
    
    <li><a href="/docs/databases/mongodb/creating-a-mongodb-replication-set-on-ubuntu-12-04-precise/">Creating a MongoDB Replication Set on Ubuntu 12.04 (Precise) - Deprecated</a></li>
    
    
    
    <li><a href="/docs/databases/mongodb/creating-a-mongodb-replication-set-on-centos-6-4/">Creating a MongoDB Replication Set on CentOS 6.4 - Deprecated</a></li>
    
    
    
    <li><a href="/docs/databases/mongodb/build-database-clusters-with-mongodb/">Build Database Clusters with MongoDB</a></li>
    
    
    
    <li><a href="/docs/databases/postgresql/how-to-back-up-your-postgresql-database/">How to Back Up Your PostgreSQL Database</a></li>
    
    
</ul>


            
            
<p class="doc-license">This guide is published under a <a href="https://creativecommons.org/licenses/by-nd/4.0">CC BY-ND 4.0</a> license.</p>

          </div>
          <div id="doc-sidebar-container" class="col-sm-3 col-sm-pull-9 hidden-xs">
            <div id="doc-sidebar">
              <div markdown="0" class="doc-sidebar-inner" >
  <div class="input-group">
	<label class="sr-only" for="q">Search guides and tutorials</label>
	<input id="ss_keyword" name="q" type="text" class="form-control" placeholder="Search guides..."/>
	<span class="input-group-btn">
		<button type="submit" class="btn btn-blue" id="ds-search-btn"><span class="glyphicon glyphicon-search"></span></button>
	</span>
</div>
</div>

                
              <div class="doc-sidebar-inner" id="doc-sidebar-toc">
                <h3 id="doc-sidebar-title">In This Guide:</h3>
                <div class="sidebar sidebar-library nav navbar" id="markdown-toc">
                    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#what-is-postgresql">What is PostgreSQL?</a></li>
<li><a href="#before-you-begin">Before You Begin</a></li>
<li><a href="#install-postgresql">Install PostgreSQL</a></li>
<li><a href="#install-patroni">Install Patroni</a></li>
<li><a href="#install-etcd">Install etcd</a></li>
<li><a href="#install-haproxy">Install HAProxy</a></li>
<li><a href="#current-status">Current Status</a></li>
<li><a href="#configure-etcd">Configure etcd</a></li>
<li><a href="#configure-patroni">Configure Patroni</a></li>
<li><a href="#configure-haproxy">Configure HAProxy</a></li>
<li><a href="#test-the-setup">Test the Setup</a></li>
<li><a href="#possible-next-steps">Possible Next Steps</a></li>
</ul></li>
</ul>
</nav>
                </div>
              </div>
              
              <div class="library-rss">
  <a href="https://linode.com/docs/index.xml"><i class="fa fa-rss-square"></i> RSS feed</a>
</div>

              <div markdown="0" class="library-signup">
  <form action="//linode.us7.list-manage.com/subscribe/post?u=f9b54ed743e1629877750e3f4&amp;id=68bafea72a&SIGNUP=library-website"
    method="post" class="email-signup" target="_blank" novalidate="">
    <i class="fa fa-envelope"></i>
    <h6>Monthly Guides Update</h6>
    <input name="EMAIL" type="email" class="form-control input-sm"
    placeholder="Email address" required="" />
    <div style="position: absolute; left: -5000px;" aria-hidden="true">
      <input type="text" name="b_f9b54ed743e1629877750e3f4_68bafea72a"
      tabindex="-1" value="">
    </div>
    <div style="display:none">
      <input type="checkbox" value="4" name="group[13][4]"
      id="mce-group[13]-13-0" checked="">
    </div>
    <button type="submit" class="btn btn-blue btn-sm btn-border email-signup" value="Subscribe"
    name="subscribe" id="mc-embedded-subscribe">Sign Up</button>
  </form>
</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<div class="modal fade" id="img-modal" tabindex="-1" role="dialog" aria-labelledby="imageModal" aria-hidden="true">
  <div class="modal-dialog modal-full">
    <div class="modal-content">
      <div class="modal-header">
        <h4 id="img-modal-title" class="modal-title">Image Detail</h4>
      </div>
      <div class="modal-body">
        <img id="img-modal-image" class="img-responsive">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-blue" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

        <footer>
            <section class="neutral some-space">
	<div class="container">
		<div class="row">
			<div class="col-sm-12 text-center">
				<h3>Get paid to write for Linode.</h3>
				<p class="lead">We're always expanding our docs. If you like to help people, can write, and want to earn some cash, learn how you can <a href="/docs/contribute">earn up to $300 for every guide you write</a> and we publish.</p>
			</div>
		</div>
	</div>
</section>
            <section id="pre-footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-7">
        <span>Get started in the Linode Cloud today.</span>
      </div>
      <div class="col-sm-5 pad-xs">
        <a id="btn-signup-bottom" class="btn btn-lg btn-full btn-green" href="https://manager.linode.com/session/signup">Create an Account</a>
      </div>
    </div>
  </div>
</section>

<section class="dark">
  <div class="container">

    <div class="row">
      <div class="footer-col">
        <h5><a href="https://www.linode.com/linodes">Overview</a></h5>
        <ul>
          <li><a href="https://www.linode.com/pricing">Plans &amp; Pricing</a></li>
          <li><a href="https://www.linode.com/linodes">Features</a></li>
          <li><a href="https://www.linode.com/addons">Add-Ons</a></li>
          <li><a href="https://www.linode.com/managed">Managed</a></li>
          <li><a href="https://www.linode.com/professional-services">Professional Services</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h5><a href="https://linode.com/docs/">Resources</a></h5>
        <ul>
          <li><a href="https://linode.com/docs/">Guides &amp; Tutorials</a></li>
          <li><a href="https://www.linode.com/speedtest">Speed Test</a></li>
          <li><a href="https://forum.linode.com/">Forum</a></li>
          <li><a href="https://www.linode.com/chat">Chat</a></li>
          <li><a href="http://status.linode.com/">System Status</a></li>
        </ul>
      </div>


      <div class="footer-col">
        <h5><a href="https://www.linode.com/about">Company</a></h5>
        <ul>
          <li><a href="https://www.linode.com/about">About Us</a></li>
          <li><a href="https://blog.linode.com">Blog</a></li>
          <li><a href="https://www.linode.com/press">Press</a></li>
          <li><a href="https://www.linode.com/referrals">Referral System</a></li>
          <li><a href="https://www.linode.com/careers">Careers</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h5><a href="https://www.linode.com/contact">Contact Us</a></h5>
        <ul>
          <li><a href="tel:+18554546633">855-4-LINODE</a></li>
          <li><a href="tel:+18554546633">(855-454-6633)</a></li>
          <li><a href="tel:+16093807100">Intl.: +1 609-380-7100</a></li>
          <li><a href="mailto:support@linode.com">Email us</a></li>
          <li>
            <br />
            <a target="_blank" href="https://facebook.com/linode"><i class="fa fa-facebook-square"></i></a>
            <a target="_blank" href="https://twitter.com/linode"><i class="fa fa-twitter-square"></i></a>
            <a target="_blank" href="https://plus.google.com/+linode/"><i class="fa fa-google-plus-square"></i></a>
            <a target="_blank" href="https://linkedin.com/company/linode"><i class="fa fa-linkedin-square"></i></a>
            <a target="_blank" href="https://github.com/linode/"><i class="fa fa-github-square"></i></a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</section>

<section class="dark-moar">
  <div class="container">
    <div id="footer-copyright" class="row">
      <div class="col text-center">
        &copy; 2017 Linode, LLC
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/tos">Terms of Service</a>
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/privacy">Privacy Policy</a>
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/security">Security</a>
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/compliance">Standards &amp; Compliance</a>
      </div>
    </div>
  </div>
</section>

        </footer>
        
             <script src="/docs/build/js/libs.js" type="text/javascript"></script>
<script src="/docs/build/js/main.js" type="text/javascript"></script>

        
        <script type="text/javascript">
$( "img[src^='\/docs\/assets']" ).each(function () {
  $( this ).parent().bind('click', false);
  $( this ).on('click', function(e) {
    var image_title = $( this ).attr('alt');
    var image_href = $( this ).parent().attr('href') || $( this ).attr('src');
    $( '#img-modal-image' ).attr('src', image_href);
    $( '#img-modal-title' ).text(image_title);
    $( '#img-modal' ).modal({ show: true });
  });
});
</script>



        
<script type="text/javascript">
 SidebarScroll.init()
</script>

    </body>
</html>