<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Installing Mail Filtering for Ubuntu 12.04</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="description" content="Configuring Virus and Spam protection for your mail server.">
        <meta name="keywords" content="email, mail, postfix, dovecot, mysql, ubuntu, 12.04, clamav, spamassassin, amavis">
        
        <meta property="og:title" content="Installing Mail Filtering for Ubuntu 12.04">
        <meta property="og:type" content="article">
        <meta property="og:url" content="https://linode.com/docs/email/installing-mail-filtering-for-ubuntu-12-04/">
        <meta property="og:description" content="Configuring Virus and Spam protection for your mail server.">
        <meta property="og:site_name" content="Linode Guides &amp; Tutorials">
        
        
        <meta name="twitter:card" content="summary">
        
        <meta name="twitter:site" content="@linode">
        <link rel="alternate" type="application/rss" href="https://linode.com/docs/index.xml">

        
             <link href="/docs/build/stylesheets/home.css" rel='stylesheet' type='text/css'>

        
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,900' rel='stylesheet' type='text/css'>
        <link rel="canonical" href="https://linode.com/docs/email/installing-mail-filtering-for-ubuntu-12-04/">
        <link rel="shortcut icon" href="/favicon.ico">
    </head>
    <body class="no-subnav">
         <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="searchLabel" id="ds-search-modal">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div id="ds-search-input">
				<div class="input-group col-md-12">
					<input id="ds-search" type="text" class="form-control input-lg" placeholder="Search" />
					<span class="input-group-btn">
						<button class="btn btn-info btn-lg" id="ds-search-btn-modal" type="button">
						<i class="glyphicon glyphicon-search"></i>
						</button>
					</span>
				</div>
				<ul class="list-group" id="ds-search-list">
				</ul>
			</div>
		</div>
	</div>
</div> 
         
        <header>
            <nav id="main-nav" class="navbar navbar-default" role="navigation">
  <div class="container">

    <div class="navbar-header">
      <button type="button" class="toggle navbar-toggle" data-toggle="collapse" data-target=".navbar-top-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://www.linode.com"><img id="navbar-logo" src="/docs/media/images/header/linode-logo.svg" style="height:57px"></a>
    </div>

    <div class="collapse navbar-collapse navbar-top-collapse">
      <ul class="nav navbar-nav navbar-right">

                <li><a href="https://www.linode.com/"><span class='nav-home'></span></a></li>
                <li><a href="https://www.linode.com/linodes">Features</a></li>
                <li><a href="https://www.linode.com/pricing">Pricing</a></li>
                <li><a href="https://www.linode.com/addons">Add-ons</a></li>

        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Resources <span class="caret"></span></a>
          <ul class="dropdown-menu dropdown-main-nav dropdown-mega">
            <li class="dropdown-third">
              <ul >
                <li><a href="https://linode.com/docs/getting-started">Getting Started</a></li>
                <li><a href="https://linode.com/docs/migrate-from-shared">Migrating to Linode</a></li>
                <li><a href="https://linode.com/docs/hosting-website">Hosting a Website</a></li>
                <li class="divider"></li>
                <li class="big"><a href="https://linode.com/docs"><i class="fa fa-book"></i> Guides &amp; Tutorials</a></li>
                <li class="divider visible-xs"></li>
              </ul>
            </li>
            <li class="dropdown-third middle">
              <ul >
                <li><a href="https://www.linode.com/api">API</a></li>
                <li><a href="https://www.linode.com/stackscripts">StackScripts</a></li>
                <li><a href="https://www.linode.com/mobile">Mobile</a></li>
                <li><a href="https://www.linode.com/cli" target="_blank">CLI</a></li>

                <li class="divider"></li>

                <li><a href="https://www.linode.com/chat"><i class="fa fa-bullhorn gray"></i> Chat</a></li>
                <li><a href="https://forum.linode.com"><i class="fa fa-comments"></i> Community Forum</a></li>
                <li class="divider visible-xs"></li>
              </ul>
            </li>
            <li class="dropdown-third">
              <ul >
                <li><a href="https://blog.linode.com">Blog</a></li>
                <li><a href="http://status.linode.com">System Status</a></li>
                <li><a href="https://www.linode.com/speedtest">Speed Test</a></li>
                <li><a href="https://www.linode.com/about">About Us</a></li>
                <li class="divider"></li>
                <li><a href="https://www.linode.com/contact"><i class="fa fa-user"></i> Contact Support</a></li>
              </ul>
            </li>
          </ul>
        </li>

        <li role="presentation" class="divider-vertical"><span>|</span></li>
          <li class=""><a href="https://manager.linode.com/">Log in <span class="login-caret"></span></a></li>
          <li class="visible-xs"><a href="https://manager.linode.com/session/signup">Sign up</a></li>
          <li class="hidden-xs"><div><a id="btn-signup-top" class="btn btn-sm btn-green navbar-btn hidden-xs" href="https://manager.linode.com/session/signup">Sign up</a></div></li>
      </ul>
    </div>

  </div>
</nav>

            <nav class="navbar subnav jumbotron" role="navigation">
  <div class="container">
    <div class="subnav-divider">

    </div>
  </div>
</nav>
        </header>
        
<section class="primary first-section">
  <div class="container">
    <div class="row breadcrumb-row">
  <div class="col-sm-12">
    <ol class="breadcrumb library-breadcrumb">
      





<li>
  
  <a href="https://linode.com/docs/">Guides &amp; Tutorials</a>
  
</li>


<li>
  
  <a href="https://linode.com/docs/email/">Email Server Guides</a>
  
</li>


<li>
  
  Installing Mail Filtering for Ubuntu 12.04
  
</li>

    </ol>
  </div>
</div>

    <div class="row" itemscope itemtype="http://schema.org/TechArticle">
      <div class="col-sm-12">
        <div class="row">
          <div class="col-sm-9 col-sm-offset-3">
          </div>
        </div>
        <div class="row">
          <div id="article-body" class="col-sm-9 col-sm-push-3 doc">
            <h1 class="doc-title" itemprop="headline">Installing Mail Filtering for Ubuntu 12.04</h1>
<p markdown="0" class="doc-time doc-modified-time">
  <small class="updated">Updated <time itemprop="dateModified" datetime="2014-04-04T00:00:00Z">Friday, April 4, 2014</time> by Alex Fornuto</small>
  
</p>

           <div class="row">
            <div class="col-sm-9"><div markdown="0" class="signup-top">
    <span>
        Use promo code <strong>DOCS10</strong> for $10 credit on a new account.
    </span>
    <form action="https://manager.linode.com/session/signup" style="display: inline">
        <button type="submit" target="_blank" class="btn btn-blue btn-sm btn-border">Try this Guide</button>
    </form>
</div>
</div>
            <div class="col-sm-3"><div class="social-share">
    <div class="btn-group share-group">
        <a data-toggle="dropdown" class="btn btn-info">
            <i class="fa fa-share-alt fa-inverse"></i>
        </a>
        <button href="#" data-toggle="dropdown" class="btn btn-info dropdown-toggle share">
        <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
            <li>
                <a data-original-title="Twitter" rel="tooltip"  href="https://twitter.com/share?url=https%3a%2f%2flinode.com%2fdocs%2femail%2finstalling-mail-filtering-for-ubuntu-12-04%2f&via=linode&text=Installing%20Mail%20Filtering%20for%20%e2%80%a6" class="btn btn-twitter" data-placement="left" target="_blank" rel="noopener">
                    <i class="fa fa-twitter"></i>
                </a>
            </li>
            <li>
                <a data-original-title="Facebook" rel="tooltip"  href="http://www.facebook.com/sharer.php?u=https%3a%2f%2flinode.com%2fdocs%2femail%2finstalling-mail-filtering-for-ubuntu-12-04%2f" class="btn btn-facebook" data-placement="left" target="_blank" rel="noopener">
                    <i class="fa fa-facebook"></i>
                </a>
            </li>
            <li>
                <a data-original-title="Hacker News" rel="tooltip"  href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2flinode.com%2fdocs%2femail%2finstalling-mail-filtering-for-ubuntu-12-04%2f&t=Installing%20Mail%20Filtering%20for%20Ubuntu%2012.04" class="btn btn-hacker-news" data-placement="left" target="_blank" rel="noopener">
                    <i class="fa fa-hacker-news "></i>
                </a>
            </li>
        </ul>
    </div>
</div></div>
            </div>
            <div class="library-github" markdown="0">
	<i class="fa fa-github"></i>
	<strong>Contribute on GitHub</strong>
	<p>
		
		<a href="https://github.com/linode/docs">View Project</a> |
		<a href="https://github.com/linode/docs/blob/master/docs/email/installing-mail-filtering-for-ubuntu-12-04.md">View File</a> |
		<a href="https://github.com/linode/docs/edit/master/docs/email/installing-mail-filtering-for-ubuntu-12-04.md">Edit File</a>
	</p>
</div>
            
            
<blockquote class="deprecated">
	<strong class="callout-title">Deprecated</strong>
	<div>This guide has been deprecated and is no longer being maintained.</div>
	<div>
		
	</div>
</blockquote>


            

<p>If you&rsquo;re running a mail server, it&rsquo;s a good idea to have spam and virus filtering. Spam can flood your users&rsquo; inboxes, and those running insecure local PCs are susceptible to virus infection. Protecting your email server protects your clients and you. This guide goes through the installation and configuration of virus and spam filtering, using Amavis-new, ClamAV, and SpamAssassin.</p>

<blockquote class="caution">
  <strong class="callout-title">Caution</strong>
  <div>This is a generic introductory guide. You are responsible for ensuring that your virus/spam filtering system meets the needs of your environment.</div>
</blockquote>


<h2 id="prerequisites">Prerequisites</h2>

<p>This guide assumes you have already followed our <a href="/docs/email/postfix/email-with-postfix-dovecot-and-mysql">Email with Postfix, Dovecot, and MySQL</a> guides and are running Ubuntu 12.04 LTS. This guide is written for the root user, and all commands listed require root privileges.</p>

<h2 id="installation">Installation</h2>

<p>Run the following commands to install all the necessary packages:</p>

<pre><code>apt-get update
apt-get upgrade
apt-get install amavisd-new spamassassin clamav-daemon libnet-dns-perl libmail-spf-perl pyzor razor
</code></pre>

<p><strong>Optional:</strong> Installing the following packages will allow your filters to better scan through various archive files. Unless you&rsquo;re deploying on a small disk where storage is a concern, this step is recommended:</p>

<pre><code>apt-get install arj bzip2 cabextract cpio file gzip lha nomarch pax rar unrar unzip zip zoo
</code></pre>

<h2 id="configuration">Configuration</h2>

<p>In this section, we&rsquo;ll configure the newly installed software to work with our existing mail server.</p>

<h3 id="clamav">ClamAV</h3>

<p>Here, we&rsquo;ll make sure ClamAV stays updated with the latest virus definitions.</p>

<ol>
<li><p>We will configure ClamAV to update its database regularly, but it&rsquo;s a good idea to perform a manual update after installation:</p>

<pre><code>freshclam
</code></pre></li>

<li><p>The following commands add the ClamAV and Amavis users to each others&rsquo; groups, which prevents ownership issues from inhibiting scans:</p>

<pre><code>adduser clamav amavis
adduser amavis clamav
</code></pre></li>

<li><p>To make sure that virus definitions are updated regularly, we will add a cron job. Make sure you run this as root or with the <code>sudo</code> prefix. You may be asked to choose an editor. If you&rsquo;re unsure, choose <code>nano</code>:</p>

<pre><code>crontab -e
</code></pre></li>
</ol>

<dl class="file">
<dt>


		crontab 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span><span class="lnt">12</span><span class="lnt">13</span><span class="lnt">14</span><span class="lnt">15</span><span class="lnt">16</span><span class="lnt">17</span><span class="lnt">18</span><span class="lnt">19</span><span class="lnt">20</span><span class="lnt">21</span><span class="lnt">22</span><span class="lnt">23</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Edit this file to introduce tasks to be run by cron.
</span><span class="c1">#
</span><span class="c1"># Each task to run has to be defined through a single line
</span><span class="c1"># indicating with different fields when the task will be run
</span><span class="c1"># and what command to run for the task
</span><span class="c1">#
</span><span class="c1"># To define the time you can provide concrete values for
</span><span class="c1"># minute (m), hour (h), day of month (dom), month (mon),
</span><span class="c1"># and day of week (dow) or use &#39;*&#39; in these fields (for &#39;any&#39;).#
</span><span class="c1"># Notice that tasks will be started based on the cron&#39;s system
</span><span class="c1"># daemon&#39;s notion of time and timezones.
</span><span class="c1">#
</span><span class="c1"># Output of the crontab jobs (including errors) is sent through
</span><span class="c1"># email to the user the crontab file belongs to (unless redirected).
</span><span class="c1">#
</span><span class="c1"># For example, you can run a backup of all your user accounts
</span><span class="c1"># at 5 a.m every week with:
</span><span class="c1"># 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/
</span><span class="c1">#
</span><span class="c1"># For more information see the manual pages of crontab(5) and cron(8)
</span><span class="c1">#
</span><span class="c1"># m h  dom mon dow   command
</span><span class="c1"></span>  <span class="m">0</span> <span class="m">1</span> * * * /usr/bin/freshclam --quiet</code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>

<h3 id="spamassassin">SpamAssassin</h3>

<p>Here, we&rsquo;ll set various options and settings for SpamAssassin.</p>

<ol>
<li><p>Before you can start SpamAssassin for the first time, you need to edit the <code>/etc/default/spamassassin</code> file by changing the value of the <code>ENABLED</code> variable to <strong>1</strong>. Here, you can also edit the <code>CRON</code> variable to make sure that SpamAssassin updates its rules regularly:</p>

<dl class="file">
<dt>


		/etc/default/spamassassin 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">...

<span class="c1"># Change to one to enable spamd
</span><span class="c1"></span><span class="nv">ENABLED</span><span class="o">=</span><span class="m">1</span>

...

<span class="c1"># Cronjob
</span><span class="c1"># Set to anything but 0 to enable the cron job to automatically update
</span><span class="c1"># spamassassin&#39;s rules on a nightly basis
</span><span class="c1"></span><span class="nv">CRON</span><span class="o">=</span><span class="m">1</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl></li>

<li><p>Make a copy of the default configuration file:</p>

<pre><code>cp /etc/spamassassin/local.cf /etc/spamassassin/local.cf.orig
</code></pre></li>

<li><p>SpamAssassin scores incoming messages and assigns a score based on its spam characteristics. A score of 0 is considered safe, while a score of 10 or higher is usually spam. You need to adjust its configuration file to determine what score threshold will be allowed through the filter. We&rsquo;re going to use 8, but this can be adjusted later. Locate and uncomment the line <code># required_score 5.0</code> by removing the <strong>#</strong> symbol, and adjust the value to 8:</p>

<dl class="file">
<dt>


		/etc/spamassassin/local.cf 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1</span><span class="lnt">2</span><span class="lnt">3</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#   Set the threshold at which a message is considered spam (default: 5.0)
</span><span class="c1">#
</span><span class="c1"></span>required_score <span class="m">8</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl></li>

<li><p>Once finished, save and exit the file. If you&rsquo;re using Nano the command is Control + x.</p></li>

<li><p>Start the SpamAssassin daemon:</p>

<pre><code>service spamassassin start
</code></pre></li>
</ol>

<h3 id="amavis">Amavis</h3>

<ol>
<li><p>On Debian-based systems like Ubuntu, Amavis splits its configuration among several files. Enable spam and antivirus filtering by opening the <code>/etc/amavis/conf.d/15-content_filter_mode</code> file and removing the comment symbols (<strong>#</strong>) from the two bypass blocks, as shown below:</p>

<dl class="file">
<dt>


		/etc/amavis/conf.d/15-content\\_filter\\_mode 


</dt>
<dd>







<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-perl" data-lang="perl"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span><span class="lnt">12</span><span class="lnt">13</span><span class="lnt">14</span><span class="lnt">15</span><span class="lnt">16</span><span class="lnt">17</span><span class="lnt">18</span><span class="lnt">19</span><span class="lnt">20</span><span class="lnt">21</span><span class="lnt">22</span><span class="lnt">23</span><span class="lnt">24</span><span class="lnt">25</span><span class="lnt">26</span><span class="lnt">27</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-perl" data-lang="perl"><span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>

<span class="c1"># You can modify this file to re-enable SPAM checking through spamassassin</span>
<span class="c1"># and to re-enable antivirus checking.</span>

<span class="c1">#</span>
<span class="c1"># Default antivirus checking mode</span>
<span class="c1"># Please note, that anti-virus checking is DISABLED by</span>
<span class="c1"># default.</span>
<span class="c1"># If You wish to enable it, please uncomment the following lines:</span>


<span class="nv">@bypass_virus_checks_maps</span> <span class="o">=</span> <span class="p">(</span>
   <span class="o">\</span><span class="nv">%bypass_virus_checks</span><span class="p">,</span> <span class="o">\</span><span class="nv">@bypass_virus_checks_acl</span><span class="p">,</span> <span class="o">\</span><span class="nv">$bypass_virus_checks_re</span><span class="p">);</span>


<span class="c1">#</span>
<span class="c1"># Default SPAM checking mode</span>
<span class="c1"># Please note, that anti-spam checking is DISABLED by</span>
<span class="c1"># default.</span>
<span class="c1"># If You wish to enable it, please uncomment the following lines:</span>


<span class="nv">@bypass_spam_checks_maps</span> <span class="o">=</span> <span class="p">(</span>
   <span class="o">\</span><span class="nv">%bypass_spam_checks</span><span class="p">,</span> <span class="o">\</span><span class="nv">@bypass_spam_checks_acl</span><span class="p">,</span> <span class="o">\</span><span class="nv">$bypass_spam_checks_re</span><span class="p">);</span>

<span class="mi">1</span><span class="p">;</span>  <span class="c1"># ensure a defined return</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>

<blockquote class="note">
  <strong class="callout-title">Note</strong>
  <div>Be sure to remove all four <strong>#</strong> symbols, as shown above.</div>
</blockquote>
</li>

<li><p>Once finished, save and exit the file.</p></li>

<li><p>Restart Amavis:</p>

<pre><code>service amavis restart
</code></pre></li>

<li><p>Open the Postfix main configuration file. If you followed our Email with Postfix Dovecot and MySQL guide, you should already have a backup. Add the following line to the bottom of the file:</p>

<dl class="file">
<dt>


		/etc/postfix/main.cf 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1</span><span class="lnt">2</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Additional option for filtering
</span><span class="c1"></span><span class="nv">content_filter</span> <span class="o">=</span> smtp-amavis:<span class="o">[</span><span class="m">127</span>.0.0.1<span class="o">]</span>:10024</code></pre></td></tr></table>
</div>
</div>
</dd>
</dl></li>

<li><p>The next configuration file to edit is <code>/etc/postfix/master.cf</code>. On a new line below the <code>pickup</code> directive, add the following options:</p>

<dl class="file">
<dt>


		/etc/postfix/master.cf 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1</span><span class="lnt">2</span><span class="lnt">3</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">pickup    fifo  n       -       -       <span class="m">60</span>      <span class="m">1</span>       pickup
         -o <span class="nv">content_filter</span><span class="o">=</span>
         -o <span class="nv">receive_override_options</span><span class="o">=</span>no_header_body_checks</code></pre></td></tr></table>
</div>
</div>
</dd>
</dl></li>

<li><p>Add the following lines to the bottom of the file, and be sure to include the indents on lines beginning with <code>-o</code>:</p>

<dl class="file">
<dt>


		/etc/postfix/master.cf 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span><span class="lnt">12</span><span class="lnt">13</span><span class="lnt">14</span><span class="lnt">15</span><span class="lnt">16</span><span class="lnt">17</span><span class="lnt">18</span><span class="lnt">19</span><span class="lnt">20</span><span class="lnt">21</span><span class="lnt">22</span><span class="lnt">23</span><span class="lnt">24</span><span class="lnt">25</span><span class="lnt">26</span><span class="lnt">27</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Options for the filter
</span><span class="c1"></span>smtp-amavis     unix    -       -       -       -       <span class="m">2</span>       smtp
        -o <span class="nv">smtp_data_done_timeout</span><span class="o">=</span><span class="m">1200</span>
        -o <span class="nv">smtp_send_xforward_command</span><span class="o">=</span>yes
        -o <span class="nv">disable_dns_lookups</span><span class="o">=</span>yes
        -o <span class="nv">max_use</span><span class="o">=</span><span class="m">20</span>

<span class="c1"># Listener for filtered mail
</span><span class="c1"></span><span class="m">127</span>.0.0.1:10025 inet    n       -       -       -       -       smtpd
        -o <span class="nv">content_filter</span><span class="o">=</span>
        -o <span class="nv">local_recipient_maps</span><span class="o">=</span>
        -o <span class="nv">relay_recipient_maps</span><span class="o">=</span>
        -o <span class="nv">smtpd_restriction_classes</span><span class="o">=</span>
        -o <span class="nv">smtpd_delay_reject</span><span class="o">=</span>no
        -o <span class="nv">smtpd_client_restrictions</span><span class="o">=</span>permit_mynetworks,reject
        -o <span class="nv">smtpd_helo_restrictions</span><span class="o">=</span>
        -o <span class="nv">smtpd_sender_restrictions</span><span class="o">=</span>
        -o <span class="nv">smtpd_recipient_restrictions</span><span class="o">=</span>permit_mynetworks,reject
        -o <span class="nv">smtpd_data_restrictions</span><span class="o">=</span>reject_unauth_pipelining
        -o <span class="nv">smtpd_end_of_data_restrictions</span><span class="o">=</span>
        -o <span class="nv">mynetworks</span><span class="o">=</span><span class="m">127</span>.0.0.0/8
        -o <span class="nv">smtpd_error_sleep_time</span><span class="o">=</span><span class="m">0</span>
        -o <span class="nv">smtpd_soft_error_limit</span><span class="o">=</span><span class="m">1001</span>
        -o <span class="nv">smtpd_hard_error_limit</span><span class="o">=</span><span class="m">1000</span>
        -o <span class="nv">smtpd_client_connection_count_limit</span><span class="o">=</span><span class="m">0</span>
        -o <span class="nv">smtpd_client_connection_rate_limit</span><span class="o">=</span><span class="m">0</span>
        -o <span class="nv">receive_override_options</span><span class="o">=</span>no_header_body_checks,no_unknown_recipient_checks</code></pre></td></tr></table>
</div>
</div>
</dd>
</dl></li>

<li><p>Load the new configuration into Postfix:</p>

<pre><code>service postfix reload
</code></pre></li>
</ol>

<h2 id="testing-clamav">Testing ClamAV</h2>

<p>You&rsquo;ll want to test that your email server is removing malicious emails from your users&rsquo; inboxes. <a href="http://www.eicar.org/">The European Expert Group For IT-Security</a> has files available for download that will be seen by ClamAV as a virus. You can download these test virus files <a href="http://www.eicar.org/85-0-Download.html">here</a>.</p>

<blockquote class="note">
  <strong class="callout-title">Note</strong>
  <div>Please be aware that if you are running antivirus software locally, it may block these test files. Be sure to read the <code>Important Note</code> section of the EICAR download page before you continue.</div>
</blockquote>


<p>You can send these files as attachments to an email address on your mail server. If ClamAV is working, the recipient shouldn&rsquo;t see the email and your <code>/var/log/mail.log</code> file should have lines similar to this:</p>

<pre><code>mail amavis[18034]: (18034-02) Blocked INFECTED (Eicar-Test-Signature)
</code></pre>

<p>You can quickly search for these lines with the command:</p>

<pre><code>cat /var/log/mail.log | grep INFECTED
</code></pre>

<h2 id="testing-spamassassin">Testing SpamAssassin</h2>

<p>The string below is used for testing spam filters. By sending it in an email (without whitespace or extra lines), you can test that the SpamAssassin filter is active:</p>

<pre><code>XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X
</code></pre>

<p>You can search for the relevant logfiles with <code>cat /var/log/mail.log | grep SPAM</code></p>

<h2 id="enabling-notifications">Enabling Notifications</h2>

<p>Depending on the amount of users and activity on your mail server, you may wish to receive notifications when ClamAV identifies and removes an incoming virus, or SpamAssassin filters an email as spam. If you want to receive emails, open the file <code>/etc/amavis/conf.d/21-ubuntu_defaults</code>. Add the desired email address to the <strong>\$virus_admin</strong> and <strong>\$spam_admin</strong> parameters, as shown below.</p>

<dl class="file">
<dt>


		/etc/amavis/conf.d/21-ubuntu\\_defaults 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span><span class="lnt">12</span><span class="lnt">13</span><span class="lnt">14</span><span class="lnt">15</span><span class="lnt">16</span><span class="lnt">17</span><span class="lnt">18</span><span class="lnt">19</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">use strict<span class="p">;</span>

<span class="c1">#
</span><span class="c1"># These are Ubuntu specific defaults for amavisd-new configuration
</span><span class="c1">#
</span><span class="c1"># DOMAIN KEYS IDENTIFIED MAIL (DKIM)
</span><span class="c1"></span><span class="nv">$enable_dkim_verification</span> <span class="o">=</span> <span class="m">1</span><span class="p">;</span>
<span class="c1"># Don&#39;t be verbose about sending mail:
</span><span class="c1"></span>@whitelist_sender_acl <span class="o">=</span> qw<span class="o">(</span> .<span class="nv">$mydomain</span> <span class="o">)</span><span class="p">;</span>
<span class="nv">$final_virus_destiny</span>      <span class="o">=</span> D_DISCARD<span class="p">;</span> <span class="c1"># (defaults to D_BOUNCE)
</span><span class="c1"></span><span class="nv">$final_banned_destiny</span>     <span class="o">=</span> D_DISCARD<span class="p">;</span>  <span class="c1"># (defaults to D_BOUNCE)
</span><span class="c1"></span><span class="nv">$final_spam_destiny</span>       <span class="o">=</span> D_DISCARD<span class="p">;</span>  <span class="c1"># (defaults to D_REJECT)
</span><span class="c1"></span><span class="nv">$final_bad_header_destiny</span> <span class="o">=</span> D_PASS<span class="p">;</span>  <span class="c1"># (defaults to D_PASS), D_BOUNCE suggested
</span><span class="c1"></span>
<span class="nv">$virus_admin</span> <span class="o">=</span> <span class="s1">&#39;admin@example.com&#39;</span><span class="p">;</span>
<span class="nv">$spam_admin</span> <span class="o">=</span> <span class="s1">&#39;admin@example.com&#39;</span><span class="p">;</span>

<span class="c1">#------------ Do not modify anything below this line -------------
</span><span class="c1"></span><span class="m">1</span><span class="p">;</span>  # insure a defined <span class="k">return</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>

<p>After changing this file, you will need to restart Amavis:</p>

<pre><code>service amavis restart
</code></pre>

<h3 id="optional-settings">Optional Settings</h3>

<ol>
<li><p>You can whitelist senders to ensure that their messages are never filtered. Likewise, you can blacklist senders that you feel should always be filtered. The lines to add to <code>/etc/amavis/conf.d/40-policy_banks</code> would look like this:</p>

<pre><code>@whitelist_sender_maps = (['docs@linode.com']);
@blacklist_sender_maps = (['.gmail.com', 'scammer@junk.org']);
</code></pre>

<p>In the example above all email from <code>docs@linode.com</code> will be passed through regardless of its spam score. All emails from any Gmail address, as well as <code>scammer@junk.org</code>, will be flagged as spam. Please note that spammers often spoof the sender address, so whitelisting an entire domain may or may not be a good idea in your situation. When you are done, save and exit this file.</p></li>

<li><p>If you decide to modify these values, you will need to restart Amavis before they will take effect:</p>

<pre><code>service amavis restart
</code></pre></li>
</ol>

            
<h2>More Information</h2>
<p>You may wish to consult the following resources for additional information on this topic. While these are provided in the hope that they will be useful, please note that we cannot vouch for the accuracy or timeliness of externally hosted materials.</p>
<ul>

<li><a href="http://spamassassin.apache.org/">The Official SpamAssassin Site</a></li>

<li><a href="http://www.clamav.net/">The Official ClamAV Site</a></li>

<li><a href="https://help.ubuntu.com/community/PostfixAmavisNew">Ubuntu Community Documentation</a></li>

<li><a href="http://www.akadia.com/services/postfix_amavisd.html#Globally%20Sender%20Whitelists%20and%20Blacklists">Whitelisting and Blacklisting in Amavis</a></li>

</ul>


            

<h2>See Also</h2>
<ul>
    
    
    <li><a href="/docs/email/zimbra/zimbra-on-ubuntu-14-04/">Install Zimbra Open Source Edition on Ubuntu 14.04</a></li>
    
    
    
    <li><a href="/docs/email/postfix/troubleshooting-problems-with-postfix-dovecot-and-mysql/">Troubleshooting Problems with Postfix, Dovecot, and MySQL</a></li>
    
    
    
    <li><a href="/docs/email/postfix/postfix-dovecot-and-system-user-accounts-on-debian-5-lenny/">Postfix, Dovecot, and System User Accounts on Debian 5 (Lenny) - Deprecated</a></li>
    
    
    
    <li><a href="/docs/email/postfix/email-with-postfix-dovecot-and-mysql-on-ubuntu-10-10-maverick/">Email with Postfix, Dovecot and MySQL on Ubuntu 10.10 (Maverick) - Deprecated</a></li>
    
    
    
    <li><a href="/docs/email/postfix/email-with-postfix-dovecot-and-mysql-on-ubuntu-10-04-lts-lucid/">Email with Postfix, Dovecot and MySQL on Ubuntu 10.04 LTS (Lucid) - Deprecated</a></li>
    
    
</ul>


            
            
<p class="doc-license">This guide is published under a <a href="https://creativecommons.org/licenses/by-nd/4.0">CC BY-ND 4.0</a> license.</p>

          </div>
          <div id="doc-sidebar-container" class="col-sm-3 col-sm-pull-9 hidden-xs">
            <div id="doc-sidebar">
              <div markdown="0" class="doc-sidebar-inner" >
  <div class="input-group">
	<label class="sr-only" for="q">Search guides and tutorials</label>
	<input id="ss_keyword" name="q" type="text" class="form-control" placeholder="Search guides..."/>
	<span class="input-group-btn">
		<button type="submit" class="btn btn-blue" id="ds-search-btn"><span class="glyphicon glyphicon-search"></span></button>
	</span>
</div>
</div>

                
              <div class="doc-sidebar-inner" id="doc-sidebar-toc">
                <h3 id="doc-sidebar-title">In This Guide:</h3>
                <div class="sidebar sidebar-library nav navbar" id="markdown-toc">
                    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#configuration">Configuration</a>
<ul>
<li><a href="#clamav">ClamAV</a></li>
<li><a href="#spamassassin">SpamAssassin</a></li>
<li><a href="#amavis">Amavis</a></li>
</ul></li>
<li><a href="#testing-clamav">Testing ClamAV</a></li>
<li><a href="#testing-spamassassin">Testing SpamAssassin</a></li>
<li><a href="#enabling-notifications">Enabling Notifications</a>
<ul>
<li><a href="#optional-settings">Optional Settings</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
                </div>
              </div>
              
              <div class="library-rss">
  <a href="https://linode.com/docs/index.xml"><i class="fa fa-rss-square"></i> RSS feed</a>
</div>

              <div markdown="0" class="library-signup">
  <form action="//linode.us7.list-manage.com/subscribe/post?u=f9b54ed743e1629877750e3f4&amp;id=68bafea72a&SIGNUP=library-website"
    method="post" class="email-signup" target="_blank" novalidate="">
    <i class="fa fa-envelope"></i>
    <h6>Monthly Guides Update</h6>
    <input name="EMAIL" type="email" class="form-control input-sm"
    placeholder="Email address" required="" />
    <div style="position: absolute; left: -5000px;" aria-hidden="true">
      <input type="text" name="b_f9b54ed743e1629877750e3f4_68bafea72a"
      tabindex="-1" value="">
    </div>
    <div style="display:none">
      <input type="checkbox" value="4" name="group[13][4]"
      id="mce-group[13]-13-0" checked="">
    </div>
    <button type="submit" class="btn btn-blue btn-sm btn-border email-signup" value="Subscribe"
    name="subscribe" id="mc-embedded-subscribe">Sign Up</button>
  </form>
</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<div class="modal fade" id="img-modal" tabindex="-1" role="dialog" aria-labelledby="imageModal" aria-hidden="true">
  <div class="modal-dialog modal-full">
    <div class="modal-content">
      <div class="modal-header">
        <h4 id="img-modal-title" class="modal-title">Image Detail</h4>
      </div>
      <div class="modal-body">
        <img id="img-modal-image" class="img-responsive">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-blue" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

        <footer>
            <section class="neutral some-space">
	<div class="container">
		<div class="row">
			<div class="col-sm-12 text-center">
				<h3>Get paid to write for Linode.</h3>
				<p class="lead">We're always expanding our docs. If you like to help people, can write, and want to earn some cash, learn how you can <a href="/docs/contribute">earn up to $300 for every guide you write</a> and we publish.</p>
			</div>
		</div>
	</div>
</section>
            <section id="pre-footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-7">
        <span>Get started in the Linode Cloud today.</span>
      </div>
      <div class="col-sm-5 pad-xs">
        <a id="btn-signup-bottom" class="btn btn-lg btn-full btn-green" href="https://manager.linode.com/session/signup">Create an Account</a>
      </div>
    </div>
  </div>
</section>

<section class="dark">
  <div class="container">

    <div class="row">
      <div class="footer-col">
        <h5><a href="https://www.linode.com/linodes">Overview</a></h5>
        <ul>
          <li><a href="https://www.linode.com/pricing">Plans &amp; Pricing</a></li>
          <li><a href="https://www.linode.com/linodes">Features</a></li>
          <li><a href="https://www.linode.com/addons">Add-Ons</a></li>
          <li><a href="https://www.linode.com/managed">Managed</a></li>
          <li><a href="https://www.linode.com/professional-services">Professional Services</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h5><a href="https://linode.com/docs/">Resources</a></h5>
        <ul>
          <li><a href="https://linode.com/docs/">Guides &amp; Tutorials</a></li>
          <li><a href="https://www.linode.com/speedtest">Speed Test</a></li>
          <li><a href="https://forum.linode.com/">Forum</a></li>
          <li><a href="https://www.linode.com/chat">Chat</a></li>
          <li><a href="http://status.linode.com/">System Status</a></li>
        </ul>
      </div>


      <div class="footer-col">
        <h5><a href="https://www.linode.com/about">Company</a></h5>
        <ul>
          <li><a href="https://www.linode.com/about">About Us</a></li>
          <li><a href="https://blog.linode.com">Blog</a></li>
          <li><a href="https://www.linode.com/press">Press</a></li>
          <li><a href="https://www.linode.com/referrals">Referral System</a></li>
          <li><a href="https://www.linode.com/careers">Careers</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h5><a href="https://www.linode.com/contact">Contact Us</a></h5>
        <ul>
          <li><a href="tel:+18554546633">855-4-LINODE</a></li>
          <li><a href="tel:+18554546633">(855-454-6633)</a></li>
          <li><a href="tel:+16093807100">Intl.: +1 609-380-7100</a></li>
          <li><a href="mailto:support@linode.com">Email us</a></li>
          <li>
            <br />
            <a target="_blank" href="https://facebook.com/linode"><i class="fa fa-facebook-square"></i></a>
            <a target="_blank" href="https://twitter.com/linode"><i class="fa fa-twitter-square"></i></a>
            <a target="_blank" href="https://plus.google.com/+linode/"><i class="fa fa-google-plus-square"></i></a>
            <a target="_blank" href="https://linkedin.com/company/linode"><i class="fa fa-linkedin-square"></i></a>
            <a target="_blank" href="https://github.com/linode/"><i class="fa fa-github-square"></i></a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</section>

<section class="dark-moar">
  <div class="container">
    <div id="footer-copyright" class="row">
      <div class="col text-center">
        &copy; 2017 Linode, LLC
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/tos">Terms of Service</a>
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/privacy">Privacy Policy</a>
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/security">Security</a>
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/compliance">Standards &amp; Compliance</a>
      </div>
    </div>
  </div>
</section>

        </footer>
        
             <script src="/docs/build/js/libs.js" type="text/javascript"></script>
<script src="/docs/build/js/main.js" type="text/javascript"></script>

        
        <script type="text/javascript">
$( "img[src^='\/docs\/assets']" ).each(function () {
  $( this ).parent().bind('click', false);
  $( this ).on('click', function(e) {
    var image_title = $( this ).attr('alt');
    var image_href = $( this ).parent().attr('href') || $( this ).attr('src');
    $( '#img-modal-image' ).attr('src', image_href);
    $( '#img-modal-title' ).text(image_title);
    $( '#img-modal' ).modal({ show: true });
  });
});
</script>



        
<script type="text/javascript">
 SidebarScroll.init()
</script>

    </body>
</html>