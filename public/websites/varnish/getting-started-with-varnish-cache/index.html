<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Getting Started with Varnish Cache</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="description" content="Use Varnish Cache to increase your site&#39;s speed and optimize server resources">
        <meta name="keywords" content="Varnish, Ubuntu, Debian, Cache, ">
        
        <meta property="og:title" content="Getting Started with Varnish Cache">
        <meta property="og:type" content="article">
        <meta property="og:url" content="https://linode.com/docs/websites/varnish/getting-started-with-varnish-cache/">
        <meta property="og:description" content="Use Varnish Cache to increase your site&#39;s speed and optimize server resources">
        <meta property="og:site_name" content="Linode Guides &amp; Tutorials">
        
        
        <meta name="twitter:card" content="summary">
        
        <meta name="twitter:site" content="@linode">
        <link rel="alternate" type="application/rss" href="https://linode.com/docs/index.xml">

        
             <link href="/docs/build/stylesheets/home.css" rel='stylesheet' type='text/css'>

        
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,900' rel='stylesheet' type='text/css'>
        <link rel="canonical" href="https://linode.com/docs/websites/varnish/getting-started-with-varnish-cache/">
        <link rel="shortcut icon" href="/favicon.ico">
    </head>
    <body class="no-subnav">
         <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="searchLabel" id="ds-search-modal">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div id="ds-search-input">
				<div class="input-group col-md-12">
					<input id="ds-search" type="text" class="form-control input-lg" placeholder="Search" />
					<span class="input-group-btn">
						<button class="btn btn-info btn-lg" id="ds-search-btn-modal" type="button">
						<i class="glyphicon glyphicon-search"></i>
						</button>
					</span>
				</div>
				<ul class="list-group" id="ds-search-list">
				</ul>
			</div>
		</div>
	</div>
</div> 
         
        <header>
            <nav id="main-nav" class="navbar navbar-default" role="navigation">
  <div class="container">

    <div class="navbar-header">
      <button type="button" class="toggle navbar-toggle" data-toggle="collapse" data-target=".navbar-top-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://www.linode.com"><img id="navbar-logo" src="/docs/media/images/header/linode-logo.svg" style="height:57px"></a>
    </div>

    <div class="collapse navbar-collapse navbar-top-collapse">
      <ul class="nav navbar-nav navbar-right">

                <li><a href="https://www.linode.com/"><span class='nav-home'></span></a></li>
                <li><a href="https://www.linode.com/linodes">Features</a></li>
                <li><a href="https://www.linode.com/pricing">Pricing</a></li>
                <li><a href="https://www.linode.com/addons">Add-ons</a></li>

        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Resources <span class="caret"></span></a>
          <ul class="dropdown-menu dropdown-main-nav dropdown-mega">
            <li class="dropdown-third">
              <ul >
                <li><a href="https://linode.com/docs/getting-started">Getting Started</a></li>
                <li><a href="https://linode.com/docs/migrate-from-shared">Migrating to Linode</a></li>
                <li><a href="https://linode.com/docs/hosting-website">Hosting a Website</a></li>
                <li class="divider"></li>
                <li class="big"><a href="https://linode.com/docs"><i class="fa fa-book"></i> Guides &amp; Tutorials</a></li>
                <li class="divider visible-xs"></li>
              </ul>
            </li>
            <li class="dropdown-third middle">
              <ul >
                <li><a href="https://www.linode.com/api">API</a></li>
                <li><a href="https://www.linode.com/stackscripts">StackScripts</a></li>
                <li><a href="https://www.linode.com/mobile">Mobile</a></li>
                <li><a href="https://www.linode.com/cli" target="_blank">CLI</a></li>

                <li class="divider"></li>

                <li><a href="https://www.linode.com/chat"><i class="fa fa-bullhorn gray"></i> Chat</a></li>
                <li><a href="https://forum.linode.com"><i class="fa fa-comments"></i> Community Forum</a></li>
                <li class="divider visible-xs"></li>
              </ul>
            </li>
            <li class="dropdown-third">
              <ul >
                <li><a href="https://blog.linode.com">Blog</a></li>
                <li><a href="http://status.linode.com">System Status</a></li>
                <li><a href="https://www.linode.com/speedtest">Speed Test</a></li>
                <li><a href="https://www.linode.com/about">About Us</a></li>
                <li class="divider"></li>
                <li><a href="https://www.linode.com/contact"><i class="fa fa-user"></i> Contact Support</a></li>
              </ul>
            </li>
          </ul>
        </li>

        <li role="presentation" class="divider-vertical"><span>|</span></li>
          <li class=""><a href="https://manager.linode.com/">Log in <span class="login-caret"></span></a></li>
          <li class="visible-xs"><a href="https://manager.linode.com/session/signup">Sign up</a></li>
          <li class="hidden-xs"><div><a id="btn-signup-top" class="btn btn-sm btn-green navbar-btn hidden-xs" href="https://manager.linode.com/session/signup">Sign up</a></div></li>
      </ul>
    </div>

  </div>
</nav>

            <nav class="navbar subnav jumbotron" role="navigation">
  <div class="container">
    <div class="subnav-divider">

    </div>
  </div>
</nav>
        </header>
        
<section class="primary first-section">
  <div class="container">
    <div class="row breadcrumb-row">
  <div class="col-sm-12">
    <ol class="breadcrumb library-breadcrumb">
      







<li>
  
  <a href="https://linode.com/docs/">Guides &amp; Tutorials</a>
  
</li>


<li>
  
  <a href="https://linode.com/docs/websites/">Website Guides</a>
  
</li>


<li>
  
  <a href="https://linode.com/docs/websites/varnish/">Varnish Web Cache</a>
  
</li>


<li>
  
  Getting Started with Varnish Cache
  
</li>

    </ol>
  </div>
</div>

    <div class="row" itemscope itemtype="http://schema.org/TechArticle">
      <div class="col-sm-12">
        <div class="row">
          <div class="col-sm-9 col-sm-offset-3">
          </div>
        </div>
        <div class="row">
          <div id="article-body" class="col-sm-9 col-sm-push-3 doc">
            <h1 class="doc-title" itemprop="headline">Getting Started with Varnish Cache</h1>
<p markdown="0" class="doc-time doc-modified-time">
  <small class="updated">Updated <time itemprop="dateModified" datetime="2017-02-24T00:00:00Z">Friday, February 24, 2017</time> by Edward Angert</small>
  
  <small class="contributed-by">Contributed by
  
  Kevin Cupp
  
  </small>
  
</p>

           <div class="row">
            <div class="col-sm-9"><div markdown="0" class="signup-top">
    <span>
        Use promo code <strong>DOCS10</strong> for $10 credit on a new account.
    </span>
    <form action="https://manager.linode.com/session/signup" style="display: inline">
        <button type="submit" target="_blank" class="btn btn-blue btn-sm btn-border">Try this Guide</button>
    </form>
</div>
</div>
            <div class="col-sm-3"><div class="social-share">
    <div class="btn-group share-group">
        <a data-toggle="dropdown" class="btn btn-info">
            <i class="fa fa-share-alt fa-inverse"></i>
        </a>
        <button href="#" data-toggle="dropdown" class="btn btn-info dropdown-toggle share">
        <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
            <li>
                <a data-original-title="Twitter" rel="tooltip"  href="https://twitter.com/share?url=https%3a%2f%2flinode.com%2fdocs%2fwebsites%2fvarnish%2fgetting-started-with-varnish-cache%2f&via=linode&text=Getting%20Started%20with%20Varnish%20%e2%80%a6" class="btn btn-twitter" data-placement="left" target="_blank" rel="noopener">
                    <i class="fa fa-twitter"></i>
                </a>
            </li>
            <li>
                <a data-original-title="Facebook" rel="tooltip"  href="http://www.facebook.com/sharer.php?u=https%3a%2f%2flinode.com%2fdocs%2fwebsites%2fvarnish%2fgetting-started-with-varnish-cache%2f" class="btn btn-facebook" data-placement="left" target="_blank" rel="noopener">
                    <i class="fa fa-facebook"></i>
                </a>
            </li>
            <li>
                <a data-original-title="Hacker News" rel="tooltip"  href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2flinode.com%2fdocs%2fwebsites%2fvarnish%2fgetting-started-with-varnish-cache%2f&t=Getting%20Started%20with%20Varnish%20Cache" class="btn btn-hacker-news" data-placement="left" target="_blank" rel="noopener">
                    <i class="fa fa-hacker-news "></i>
                </a>
            </li>
        </ul>
    </div>
</div></div>
            </div>
            <div class="library-github" markdown="0">
	<i class="fa fa-github"></i>
	<strong>Contribute on GitHub</strong>
	<p>
		
		<a href="https://github.com/linode/docs">View Project</a> |
		<a href="https://github.com/linode/docs/blob/master/docs/websites/varnish/getting-started-with-varnish-cache.md">View File</a> |
		<a href="https://github.com/linode/docs/edit/master/docs/websites/varnish/getting-started-with-varnish-cache.md">Edit File</a>
	</p>
</div>
            <hr />

<p><em>This is a Linode Community guide. If you&rsquo;re an expert on something for which we need a guide, you too can <a href="/docs/contribute">get paid to write for us.</a></em></p>

<hr />

            

            

<p>Does your server need to handle lots of traffic? Caching is one of the best ways to maximize the output of your Linode. But what is caching, exactly?</p>

<p>The idea behind caching is that your server shouldn&rsquo;t have to regenerate the same dynamic content from scratch every time it&rsquo;s accessed. Save your Linode&rsquo;s resources by putting a caching proxy like Varnish in front of your web service to accelerate responses to HTTP requests and reduce server workload.</p>

<p><img src="/docs/assets/varnish_tg.png" alt="Getting Started with Varnish Cache" title="Getting Started with Varnish Cache" /></p>

<p>Varnish works by handling requests before they make it to your backend; whether your backend is Apache, nginx, or any other web server. If it doesn&rsquo;t have a request cached, it will forward the request to your backend and then cache its output. You can then store these cached requests in memory, so they&rsquo;re retrieved by and delivered to clients much faster than they would be from disk.</p>

<p>Additionally, Varnish cache can be used as part of a <a href="#use-varnish-cache-for-high-availability-with-backend-polling">highly available environment</a>, which ensures uptime during high traffic loads or server failures.</p>

<p>If your web server is nginx and you plan to use Varnish cache to serve WordPress, visit Linode&rsquo;s guide to <a href="/docs/websites/varnish/use-varnish-and-nginx-to-serve-wordpress-over-ssl-and-http-on-debian-8">Using Varnish &amp; nginx to Serve WordPress over SSL &amp; HTTP on Debian 8</a>.</p>

<h2 id="before-you-begin">Before You Begin</h2>

<ol>
<li><p>Familiarize yourself with our <a href="/docs/getting-started">Getting Started</a> guide and complete the steps for setting your Linode&rsquo;s hostname and timezone.</p></li>

<li><p>Complete the sections of our <a href="/docs/security/securing-your-server">Securing Your Server</a> guide to create a standard user account, harden SSH access and remove unnecessary network services.</p></li>

<li><p>Install and configure a <a href="/docs/websites/">web server</a> like Apache or nginx.</p></li>

<li><p>Update your system:</p>

<pre><code>sudo apt update &amp;&amp; sudo apt upgrade
</code></pre></li>
</ol>

<blockquote class="note">
  <strong class="callout-title">Note</strong>
  <div>This guide is written for a non-root user. Commands that require elevated privileges are prefixed with <code>sudo</code>. If you’re not familiar with the <code>sudo</code> command, see the <a href="/docs/tools-reference/linux-users-and-groups">Users and Groups</a> guide.</div>
</blockquote>


<h2 id="install-and-configure-varnish-cache">Install and Configure Varnish Cache</h2>

<ol>
<li><p>Install Varnish with the package manager:</p>

<pre><code>sudo apt install varnish
</code></pre></li>

<li><p>To avoid having your configuration overwritten by future updates, make a copy of the default:</p>

<pre><code>cd /etc/varnish
sudo cp default.vcl user.vcl
</code></pre></li>

<li><p>Stop the Varnish service while making configuration changes:</p>

<pre><code>sudo systemctl stop varnish
</code></pre></li>
</ol>

<h3 id="configure-varnish-backend-with-systemd">Configure Varnish Backend with Systemd</h3>

<p>Varnish is configured via <a href="https://www.varnish-cache.org/docs/4.0/reference/vcl.html">Varnish Configuration Language (VCL)</a>. Once the configuration file is loaded by the system, Varnish translates and compiles the VCL code into a C program that runs alongside the Varnish process.</p>

<p>Recent versions of Debian (8 and newer) and Ubuntu (15.04 and newer) require Varnish configuration through <em>systemd</em>.</p>

<ol>
<li><p>Open the <code>varnish.service</code> file, set the port, configuration file, and <em>memory allocation</em> on the <code>ExecStart</code> line. In the following example, these values are: <code>-a :80</code>, <code>/etc/varnish/user.vcl</code>, and <code>malloc,1G</code>.</p>

<dl class="file-excerpt">
<dt>


		/lib/systemd/system/varnish.service 


</dt>
<dd>







<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">ExecStart</span><span class="o">=</span>/usr/sbin/varnishd -j unix,user<span class="o">=</span>vcache -F -a :80 -T localhost:6082 -f /etc/varnish/user.vcl -S /etc/varnish/secret -s malloc,1G</code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>
</li>

<li><p>The configuration above allocates a maximum of 1GB of memory to store its cache items. If you need to adjust this allocation, edit the number in <code>-s malloc,1G</code>. For example, to allocate 2GB of memory:</p>

<pre><code>-s malloc,2G
</code></pre></li>

<li><p>Reload systemd:</p>

<pre><code>sudo systemctl daemon-reload
</code></pre></li>
</ol>

<h3 id="modify-custom-varnish-configuration-vcl">Modify Custom Varnish Configuration VCL</h3>

<p>Now that you&rsquo;ve pointed the Varnish start script to <code>user.vcl</code>, you need to configure that file to serve the content Varnish gets from the web server. Edit the <code>backend default {</code> section of <code>/etc/varnish/user.vcl</code> to tell Varnish where to get the server (backend) content. The example below  uses port <code>8080</code>, a web server setting you  will configure later:</p>

<dl class="file-excerpt">
<dt>


		/etc/varnish/user.vcl 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1</span><span class="lnt">2</span><span class="lnt">3</span><span class="lnt">4</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">backend default <span class="o">{</span>
    .host <span class="o">=</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">;</span>
    .port <span class="o">=</span> <span class="s2">&#34;8080&#34;</span><span class="p">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>


<h3 id="configure-cache-time-to-live-ttl">Configure Cache Time-to-Live (TTL)</h3>

<p>By default, Varnish will cache requests for two minutes. To adjust this time, open your VCL file and override the <code>vcl_backend_response</code> subroutine by updating  your backend declaration:</p>

<dl class="file-excerpt">
<dt>


		/etc/varnish/user.vcl 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1</span><span class="lnt">2</span><span class="lnt">3</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sub vcl_backend_response <span class="o">{</span>
  <span class="nb">set</span> beresp.ttl <span class="o">=</span> 5m<span class="p">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>


<p>This subroutine is called after a request is fetched from the backend. In this example, we&rsquo;re setting the TTL variable on the object to five minutes (<code>5m</code>). Values can be in seconds (<code>120s</code>), minutes (<code>2m</code>) or hours (<code>2h</code>). Your ideal TTL may vary depending on how often the content of your site is updated, and the amount of traffic you need to handle.</p>

<h2 id="take-varnish-live-configure-web-traffic-to-serve-cached-content">Take Varnish Live: Configure Web Traffic to Serve Cached Content</h2>

<p>Now that you&rsquo;ve configured Varnish, use this section to make it your web server by swapping the ports your web server and Varnish listen on. As illustrated in the graphic below, all web traffic will be served from Varnish cache and refreshed every two minutes or at the <a href="#configure-cache-time-to-live-ttl">interval configured above</a>:</p>

<p><img src="/docs/assets/varnish_cache_guide.png" alt="Where Varnish Exists in the Web Server Process" title="Where Varnish Exists in the Web Server Process" /></p>

<p>To allow Varnish to communicate with your web server, you&rsquo;ll need to modify a few settings in the virtual host file for your site.</p>

<ol>
<li><p>If you&rsquo;re using nginx, skip this step. If you&rsquo;re using Apache, change the port Apache listens on. Edit <code>/etc/apache2/ports.conf</code> and any virtual hosts. Open <code>ports.conf</code> and change the <code>80</code> in <code>Listen 80</code> to another port. Port <code>8080</code> will be used in this example:</p>

<pre><code>Listen 8080
</code></pre></li>

<li><p>Modify your virtual host file or server block to listen on port 8080:</p>

<p><strong>Apache</strong>:</p>

<dl class="file-excerpt">
<dt>


		/etc/apache2/sites-available/example.com.conf 


</dt>
<dd>







<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-aconf" data-lang="aconf"><span class="lnt">1</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-aconf" data-lang="aconf"><span class="nt">&lt;VirtualHost</span> <span class="s">*:8080</span><span class="nt">&gt;</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>


<p><strong>nginx</strong>:</p>

<dl class="file-excerpt">
<dt>


		/etc/nginx/sites-available/example.com 


</dt>
<dd>







<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-aconf" data-lang="aconf"><span class="lnt">1</span><span class="lnt">2</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-aconf" data-lang="aconf"><span class="nb">listen</span> <span class="m">8080</span>;
<span class="nb">listen</span> [::]:8080;</code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>
</li>

<li><p>Check your <code>/etc/varnish/user.vcl</code> file and make sure the <code>backend default</code> is set to use port 8080:</p>

<pre><code>backend default {
    .host = &quot;127.0.0.1&quot;;
    .port = &quot;8080&quot;;
}
</code></pre></li>

<li><p>Reload the configuration for your web server:</p>

<pre><code>sudo systemctl reload apache2
sudo systemctl restart nginx
</code></pre></li>

<li><p>Start Varnish:</p>

<pre><code>sudo systemctl start varnish
</code></pre>

<p>Once it&rsquo;s been started, Varnish will be live to site visitors and content will be served from the cache whenever possible, according to your configuration.</p></li>
</ol>

<h2 id="advanced-varnish-configuration">Advanced Varnish Configuration</h2>

<p>The VCL allows extended control over how requests are cached, and you may need to make some modifications. This section will go over a few common VCL configurations.</p>

<p>These modifications should be made in your <code>user.vcl</code> file.</p>

<h3 id="exclude-content-from-varnish-cache">Exclude Content from Varnish Cache</h3>

<p>You may want to exclude specific parts of your website from Varnish caching, particularly if there is a non-public or administrative portion. To do this, you&rsquo;ll access Varnish&rsquo;s request object for information about the request, and conditionally tell Varnish to <strong>pass</strong> the request through to the backend with no caching.</p>

<p>You&rsquo;ll need to override the <code>vcl_recv</code> subroutine in our VCL file, which is run each time Varnish receives a request, then add a conditional:</p>

<dl class="file-excerpt">
<dt>


		/etc/varnish/user.vcl 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1</span><span class="lnt">2</span><span class="lnt">3</span><span class="lnt">4</span><span class="lnt">5</span><span class="lnt">6</span><span class="lnt">7</span><span class="lnt">8</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sub vcl_recv
<span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span>req.http.host <span class="o">==</span> <span class="s2">&#34;example.com&#34;</span> <span class="o">&amp;&amp;</span>
        req.url ~ <span class="s2">&#34;^/admin&#34;</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span>pass<span class="o">)</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>


<p>This example checks for two conditions you don&rsquo;t want to cache. The first is any request for <code>example.com</code>, the second is for any URI requests that begin with <code>/admin</code>. If both of these are true, Varnish will not cache the request.</p>

<h3 id="unset-cookies">Unset Cookies</h3>

<p>As mentioned earlier, if Varnish detects your website is setting cookies, it assumes your site needs to interact with those cookies and shows dynamic content accordingly, and as a result, Varnish will not cache those pages. You can override this behavior by unsetting the <code>Cookie</code> variable on Varnish&rsquo;s <code>req.http</code> object.</p>

<p>Add this line to the bottom of the <code>vcl_recv</code> section:</p>

<dl class="file-excerpt">
<dt>


		/etc/varnish/user.vcl 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">unset</span> req.http.Cookie<span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>


<p>You may find that a particular cookie is important for displaying content or determines if your user is logged in or not. In this case, you probably don&rsquo;t want to show cached content and instead, just want to send the user straight to the backend.</p>

<p>For this case, you&rsquo;ll check <code>req.http.Cookie</code> for a cookie called &ldquo;logged_in&rdquo;, and if its found, the request will be passed on to the backend with no caching. Here&rsquo;s our entire <code>vcl_recv</code> subroutine thus far:</p>

<dl class="file-excerpt">
<dt>


		/etc/varnish/user.vcl 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sub vcl_recv
<span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span>req.http.host ~ <span class="s2">&#34;example.com&#34;</span> <span class="o">&amp;&amp;</span>
        req.url ~ <span class="s2">&#34;^/admin&#34;</span><span class="o">)</span> <span class="o">||</span>
        req.http.Cookie <span class="o">==</span> <span class="s2">&#34;logged_in&#34;</span><span class="o">)</span>
     <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span>pass<span class="o">)</span><span class="p">;</span>
     <span class="o">}</span>

     <span class="nb">unset</span> req.http.Cookie<span class="p">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>


<h3 id="to-cache-post-or-not-to-cache-post">To Cache POST, or Not to Cache POST?</h3>

<p>It&rsquo;s likely you don&rsquo;t want to cache <a href="https://en.wikipedia.org/wiki/POST_(HTTP)">POST</a> requests, because they probably need to interact with the backend to gather dynamic data or set up a user&rsquo;s session. In the example above, you chose not to cache requests if the user is logged in. This section ensures a user can log in to begin with. An easy approach is to skip POST requests all together.</p>

<p>To accomplish this, add the following condition to the existing <code>return (pass)</code> block inside of <code>vcl_recv</code>:</p>

<dl class="file-excerpt">
<dt>


		/etc/varnish/user.vcl 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1</span><span class="lnt">2</span><span class="lnt">3</span><span class="lnt">4</span><span class="lnt">5</span><span class="lnt">6</span><span class="lnt">7</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="k">if</span> <span class="o">((</span>req.http.host <span class="o">==</span> <span class="s2">&#34;example.com&#34;</span> <span class="o">&amp;&amp;</span>
    req.url ~ <span class="s2">&#34;^/admin&#34;</span><span class="o">)</span> <span class="o">||</span>
    req.http.Cookie <span class="o">==</span> <span class="s2">&#34;logged_in&#34;</span> <span class="o">||</span>
    req.method <span class="o">==</span> <span class="s2">&#34;POST&#34;</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span>pass<span class="o">)</span><span class="p">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>


<h3 id="use-varnish-cache-for-high-availability-with-backend-polling">Use Varnish Cache for High Availability with Backend Polling</h3>

<p>Varnish can use a built-in tool called <em>backend polling</em> to check on the backend server and continue serving cached content if the backend is unreachable. In the event that Varnish detects downtime, it will continue serving cached content for a <em>grace time</em> that you configure in <code>user.vcl</code>.</p>

<p>To set up polling, add a probe section to the backend declaration in <code>/etc/varnish/user.vcl</code>:</p>

<dl class="file-excerpt">
<dt>


		/etc/varnish/user.vcl 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">backend default <span class="o">{</span>
    .host <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">;</span>
    .port <span class="o">=</span> <span class="s1">&#39;8080&#39;</span><span class="p">;</span>
    .probe <span class="o">=</span> <span class="o">{</span>
        .url <span class="o">=</span> <span class="s2">&#34;/&#34;</span><span class="p">;</span>
        .timeout <span class="o">=</span> 40ms<span class="p">;</span>
        .interval <span class="o">=</span> 1s<span class="p">;</span>
        .window <span class="o">=</span> <span class="m">10</span><span class="p">;</span>
        .threshold <span class="o">=</span> <span class="m">8</span><span class="p">;</span>
     <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>


<p>These settings are just a starting point, and you may want to tweak them for your website. This example instructs Varnish to <em>poll</em>, or perform a test connection to, <code>http://127.0.0.1:8080/</code> every second, and if it takes less than 40ms to respond for at least 8 of the last 10 polls, the backend is considered healthy.</p>

<p>If the backend fails the test, it&rsquo;s considered unhealthy and objects are served out of the cache in accordance to their grace time setting. To set the grace time, include the following line in <code>vcl_backend_response</code>:</p>

<dl class="file-excerpt">
<dt>


		/etc/varnish/user.vcl 


</dt>
<dd>




<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">set</span> beresp.grace <span class="o">=</span> 1h<span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</dd>
</dl>


<p>&ldquo;1h&rdquo; allows the backend to be down for one hour without any impact to website users. If you&rsquo;re serving static content, the grace time can be even longer to ensure uptime.</p>

<h4 id="serve-varnish-cache-from-another-linode-optional">Serve Varnish Cache from Another Linode (Optional)</h4>

<p>For added availability, consider serving Varnish cache from a separate Linode. In this case, the Varnish installation steps should be performed on a separate Linode in the same datacenter as the web server. Once installed, configure the Varnish backend <code>.host</code> value to point at the web server Linode&rsquo;s <a href="/docs/networking/remote-access#adding-private-ip-addresses">private IP address</a>. Note that DNS records for your site should be pointed at the Varnish Linode, since this is where the client connects.</p>

<p>That&rsquo;s it! If everything went well, visitors to your site are now being served Varnish-cached content from memory, resulting in dramatic improvements to your site&rsquo;s speed.</p>

<h2 id="test-varnish-with-varnishlog">Test Varnish with varnishlog</h2>

<p>Now that all traffic is configured to reach Varnish cache, start <code>varnishlog</code> to view Varnish activity as it happens. Note that this is a live, ongoing log that will not show any information unless activity has occurred. Once you&rsquo;ve started Varnishlog, use a browser to view a page that should be cached and watch the log for activity:</p>

<pre><code>sudo varnishlog
</code></pre>

<p>Stop <code>varnishlog</code> with <strong>CTRL+C</strong> when done.</p>

<h2 id="firewall-rules">Firewall Rules</h2>

<p>When using a firewall, Varnish requires slight modification to the rules you may have used when setting up a web server.</p>

<p>If Varnish is running on the same Linode as your web server, be sure to allow incoming connections on port 80. However, you will also need to allow connections from localhost on port 8080, since this is how Varnish communicates with the web server.</p>

<p>If Varnish and your web server are running on separate Linodes, you&rsquo;ll need to accept incoming traffic on port 80 on the Varnish Linode, and port 8080 on the web server.</p>

<p>These two are simply the minimum rule modifications. It is strongly recommended you use additional firewall rules on each, based on the other services you have running. If you&rsquo;re not sure how to set up a firewall, check out our guides on <a href="/docs/security/firewalls/control-network-traffic-with-iptables">iptables</a> and <a href="/docs/security/firewalls/configure-firewall-with-ufw">UFW</a>.</p>

            
<h2>More Information</h2>
<p>You may wish to consult the following resources for additional information on this topic. While these are provided in the hope that they will be useful, please note that we cannot vouch for the accuracy or timeliness of externally hosted materials.</p>
<ul>

<li><a href="https://www.varnish-cache.org/docs">Official Varnish Documentation</a></li>

</ul>


            

<h2>See Also</h2>
<ul>
    
    
    <li><a href="/docs/platform/package-mirrors/">Package Mirrors</a></li>
    
    
    
    <li><a href="/docs/development/install-java-on-debian/">Install Java on Debian 8</a></li>
    
    
    
    <li><a href="/docs/security/advanced-ssh-server-security/">Use Advanced OpenSSH Features to Harden Access to Your Linode</a></li>
    
    
    
    <li><a href="/docs/websites/cms/install-odoo-10-on-ubuntu-16-04/">Install Odoo 10 on Ubuntu 16.04</a></li>
    
    
    
    <li><a href="/docs/websites/varnish/use-varnish-and-nginx-to-serve-wordpress-over-ssl-and-http-on-debian-8/">Use Varnish &amp; nginx to Serve WordPress over SSL &amp; HTTP on Debian 8</a></li>
    
    
</ul>


            
            
<p class="doc-license">This guide is published under a <a href="https://creativecommons.org/licenses/by-nd/4.0">CC BY-ND 4.0</a> license.</p>

          </div>
          <div id="doc-sidebar-container" class="col-sm-3 col-sm-pull-9 hidden-xs">
            <div id="doc-sidebar">
              <div markdown="0" class="doc-sidebar-inner" >
  <div class="input-group">
	<label class="sr-only" for="q">Search guides and tutorials</label>
	<input id="ss_keyword" name="q" type="text" class="form-control" placeholder="Search guides..."/>
	<span class="input-group-btn">
		<button type="submit" class="btn btn-blue" id="ds-search-btn"><span class="glyphicon glyphicon-search"></span></button>
	</span>
</div>
</div>

                
              <div class="doc-sidebar-inner" id="doc-sidebar-toc">
                <h3 id="doc-sidebar-title">In This Guide:</h3>
                <div class="sidebar sidebar-library nav navbar" id="markdown-toc">
                    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#before-you-begin">Before You Begin</a></li>
<li><a href="#install-and-configure-varnish-cache">Install and Configure Varnish Cache</a>
<ul>
<li><a href="#configure-varnish-backend-with-systemd">Configure Varnish Backend with Systemd</a></li>
<li><a href="#modify-custom-varnish-configuration-vcl">Modify Custom Varnish Configuration VCL</a></li>
<li><a href="#configure-cache-time-to-live-ttl">Configure Cache Time-to-Live (TTL)</a></li>
</ul></li>
<li><a href="#take-varnish-live-configure-web-traffic-to-serve-cached-content">Take Varnish Live: Configure Web Traffic to Serve Cached Content</a></li>
<li><a href="#advanced-varnish-configuration">Advanced Varnish Configuration</a>
<ul>
<li><a href="#exclude-content-from-varnish-cache">Exclude Content from Varnish Cache</a></li>
<li><a href="#unset-cookies">Unset Cookies</a></li>
<li><a href="#to-cache-post-or-not-to-cache-post">To Cache POST, or Not to Cache POST?</a></li>
<li><a href="#use-varnish-cache-for-high-availability-with-backend-polling">Use Varnish Cache for High Availability with Backend Polling</a>
<ul>
<li><a href="#serve-varnish-cache-from-another-linode-optional">Serve Varnish Cache from Another Linode (Optional)</a></li>
</ul></li>
</ul></li>
<li><a href="#test-varnish-with-varnishlog">Test Varnish with varnishlog</a></li>
<li><a href="#firewall-rules">Firewall Rules</a></li>
</ul></li>
</ul>
</nav>
                </div>
              </div>
              
              <div class="library-rss">
  <a href="https://linode.com/docs/index.xml"><i class="fa fa-rss-square"></i> RSS feed</a>
</div>

              <div markdown="0" class="library-signup">
  <form action="//linode.us7.list-manage.com/subscribe/post?u=f9b54ed743e1629877750e3f4&amp;id=68bafea72a&SIGNUP=library-website"
    method="post" class="email-signup" target="_blank" novalidate="">
    <i class="fa fa-envelope"></i>
    <h6>Monthly Guides Update</h6>
    <input name="EMAIL" type="email" class="form-control input-sm"
    placeholder="Email address" required="" />
    <div style="position: absolute; left: -5000px;" aria-hidden="true">
      <input type="text" name="b_f9b54ed743e1629877750e3f4_68bafea72a"
      tabindex="-1" value="">
    </div>
    <div style="display:none">
      <input type="checkbox" value="4" name="group[13][4]"
      id="mce-group[13]-13-0" checked="">
    </div>
    <button type="submit" class="btn btn-blue btn-sm btn-border email-signup" value="Subscribe"
    name="subscribe" id="mc-embedded-subscribe">Sign Up</button>
  </form>
</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<div class="modal fade" id="img-modal" tabindex="-1" role="dialog" aria-labelledby="imageModal" aria-hidden="true">
  <div class="modal-dialog modal-full">
    <div class="modal-content">
      <div class="modal-header">
        <h4 id="img-modal-title" class="modal-title">Image Detail</h4>
      </div>
      <div class="modal-body">
        <img id="img-modal-image" class="img-responsive">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-blue" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

        <footer>
            <section class="neutral some-space">
	<div class="container">
		<div class="row">
			<div class="col-sm-12 text-center">
				<h3>Get paid to write for Linode.</h3>
				<p class="lead">We're always expanding our docs. If you like to help people, can write, and want to earn some cash, learn how you can <a href="/docs/contribute">earn up to $300 for every guide you write</a> and we publish.</p>
			</div>
		</div>
	</div>
</section>
            <section id="pre-footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-7">
        <span>Get started in the Linode Cloud today.</span>
      </div>
      <div class="col-sm-5 pad-xs">
        <a id="btn-signup-bottom" class="btn btn-lg btn-full btn-green" href="https://manager.linode.com/session/signup">Create an Account</a>
      </div>
    </div>
  </div>
</section>

<section class="dark">
  <div class="container">

    <div class="row">
      <div class="footer-col">
        <h5><a href="https://www.linode.com/linodes">Overview</a></h5>
        <ul>
          <li><a href="https://www.linode.com/pricing">Plans &amp; Pricing</a></li>
          <li><a href="https://www.linode.com/linodes">Features</a></li>
          <li><a href="https://www.linode.com/addons">Add-Ons</a></li>
          <li><a href="https://www.linode.com/managed">Managed</a></li>
          <li><a href="https://www.linode.com/professional-services">Professional Services</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h5><a href="https://linode.com/docs/">Resources</a></h5>
        <ul>
          <li><a href="https://linode.com/docs/">Guides &amp; Tutorials</a></li>
          <li><a href="https://www.linode.com/speedtest">Speed Test</a></li>
          <li><a href="https://forum.linode.com/">Forum</a></li>
          <li><a href="https://www.linode.com/chat">Chat</a></li>
          <li><a href="http://status.linode.com/">System Status</a></li>
        </ul>
      </div>


      <div class="footer-col">
        <h5><a href="https://www.linode.com/about">Company</a></h5>
        <ul>
          <li><a href="https://www.linode.com/about">About Us</a></li>
          <li><a href="https://blog.linode.com">Blog</a></li>
          <li><a href="https://www.linode.com/press">Press</a></li>
          <li><a href="https://www.linode.com/referrals">Referral System</a></li>
          <li><a href="https://www.linode.com/careers">Careers</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h5><a href="https://www.linode.com/contact">Contact Us</a></h5>
        <ul>
          <li><a href="tel:+18554546633">855-4-LINODE</a></li>
          <li><a href="tel:+18554546633">(855-454-6633)</a></li>
          <li><a href="tel:+16093807100">Intl.: +1 609-380-7100</a></li>
          <li><a href="mailto:support@linode.com">Email us</a></li>
          <li>
            <br />
            <a target="_blank" href="https://facebook.com/linode"><i class="fa fa-facebook-square"></i></a>
            <a target="_blank" href="https://twitter.com/linode"><i class="fa fa-twitter-square"></i></a>
            <a target="_blank" href="https://plus.google.com/+linode/"><i class="fa fa-google-plus-square"></i></a>
            <a target="_blank" href="https://linkedin.com/company/linode"><i class="fa fa-linkedin-square"></i></a>
            <a target="_blank" href="https://github.com/linode/"><i class="fa fa-github-square"></i></a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</section>

<section class="dark-moar">
  <div class="container">
    <div id="footer-copyright" class="row">
      <div class="col text-center">
        &copy; 2017 Linode, LLC
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/tos">Terms of Service</a>
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/privacy">Privacy Policy</a>
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/security">Security</a>
      </div>

      <div class="col text-center">
        <a href="https://www.linode.com/compliance">Standards &amp; Compliance</a>
      </div>
    </div>
  </div>
</section>

        </footer>
        
             <script src="/docs/build/js/libs.js" type="text/javascript"></script>
<script src="/docs/build/js/main.js" type="text/javascript"></script>

        
        <script type="text/javascript">
$( "img[src^='\/docs\/assets']" ).each(function () {
  $( this ).parent().bind('click', false);
  $( this ).on('click', function(e) {
    var image_title = $( this ).attr('alt');
    var image_href = $( this ).parent().attr('href') || $( this ).attr('src');
    $( '#img-modal-image' ).attr('src', image_href);
    $( '#img-modal-title' ).text(image_title);
    $( '#img-modal' ).modal({ show: true });
  });
});
</script>



        
<script type="text/javascript">
 SidebarScroll.init()
</script>

    </body>
</html>